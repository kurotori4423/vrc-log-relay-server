<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRChat Log Relay Client</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            font-weight: bold;
            text-align: center;
        }
        .connected { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .disconnected { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .log-area { 
            border: 1px solid #ccc; 
            height: 1200px; 
            overflow-y: auto; 
            padding: 10px; 
            margin: 15px 0; 
            background-color: #f8f9fa; 
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            scroll-behavior: smooth;
            transition: scroll-top 0.3s ease-out;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        .message { 
            margin: 6px 0; 
            padding: 8px 12px; 
            border-left: 4px solid #007bff; 
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
        }
        .message:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .timestamp { 
            color: #6c757d; 
            font-size: 0.85em;
            font-weight: 500;
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e9ecef;
        }
        .message-type {
            margin-left: 10px;
            font-weight: bold;
        }
        .message-content {
            margin-top: 6px;
        }
        .log-details {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            margin: 6px 0;
        }
        .log-field {
            margin: 3px 0;
            padding: 2px 0;
        }
        .log-field strong {
            color: #495057;
            min-width: 80px;
            display: inline-block;
        }
        .log-code {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 4px 6px;
            margin: 3px 0;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 12px;
            color: #495057;
            word-break: break-all;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid #e9ecef;
        }
        pre {
            background-color: #f8f9fa !important;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .info-section {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #dc3545;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* „Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
        .filter-group {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            margin-bottom: 5px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
            color: #6c757d;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 0;
            margin: 0;
            font-family: inherit;
        }

        .filter-btn:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }

        .filter-btn:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .filter-btn:not(:first-child) {
            border-left: none;
        }

        .filter-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .filter-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .filter-btn.active:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        
        /* ÁÑ°ÂäπÂåñÁä∂ÊÖã„ÅÆ„Çπ„Çø„Ç§„É´ */
        .filter-section-disabled {
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .filter-section-disabled .filter-btn {
            cursor: not-allowed;
        }
        
        .filter-section-disabled h5 {
            color: #6c757d;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            margin: 5px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ VRChat Log Relay Client</h1>
        
        <div id="status" class="status disconnected">Êú™Êé•Á∂ö</div>
        
        <div>
            <button id="connectBtn" onclick="connect()">üîó Êé•Á∂ö</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>üîå ÂàáÊñ≠</button>
            <button onclick="clearLogs()">üóëÔ∏è „É≠„Ç∞„ÇØ„É™„Ç¢</button>
            <label class="toggle-label">
                üêõ „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
                <div class="toggle-switch">
                    <input type="checkbox" id="debugToggle" onchange="toggleDebug()">
                    <span class="toggle-slider"></span>
                </div>
            </label>
            <label class="toggle-label">
                üìú Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                <div class="toggle-switch">
                    <input type="checkbox" id="autoScrollToggle" checked onchange="toggleAutoScroll()">
                    <span class="toggle-slider"></span>
                </div>
            </label>
        </div>
        
        <div class="info-section" style="margin: 15px 0;">
            <h4>üîç „É°„ÉÉ„Çª„Éº„Ç∏„Éï„Ç£„É´„Çø„Éº</h4>
            <!-- Èö†„ÅócheckboxÔºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ -->
            <div style="display: none;">
                <input type="checkbox" id="filterLog" checked onchange="syncButtonFromCheckbox('filterLog')">
                <input type="checkbox" id="filterStatus" checked onchange="syncButtonFromCheckbox('filterStatus')">
                <input type="checkbox" id="filterSystem" checked onchange="syncButtonFromCheckbox('filterSystem')">
                <input type="checkbox" id="filterTest" checked onchange="syncButtonFromCheckbox('filterTest')">
                <input type="checkbox" id="filterUserJoin" checked onchange="syncButtonFromCheckbox('filterUserJoin')">
                <input type="checkbox" id="filterUserLeave" checked onchange="syncButtonFromCheckbox('filterUserLeave')">
                <input type="checkbox" id="filterWorldChange" checked onchange="syncButtonFromCheckbox('filterWorldChange')">
                <input type="checkbox" id="filterUnknown" checked onchange="syncButtonFromCheckbox('filterUnknown')">
                <input type="checkbox" id="filterLevelInfo" checked onchange="syncButtonFromCheckbox('filterLevelInfo')">
                <input type="checkbox" id="filterLevelWarning" checked onchange="syncButtonFromCheckbox('filterLevelWarning')">
                <input type="checkbox" id="filterLevelError" checked onchange="syncButtonFromCheckbox('filterLevelError')">
                <input type="checkbox" id="filterLevelOther" checked onchange="syncButtonFromCheckbox('filterLevelOther')">
            </div>
            <div class="filter-group">
                <button class="filter-btn active" data-filter="filterLog" onclick="toggleFilterButton(this)">üìã VRChat„É≠„Ç∞</button>
                <button class="filter-btn active" data-filter="filterStatus" onclick="toggleFilterButton(this)">üéÆ „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥</button>
                <button class="filter-btn active" data-filter="filterSystem" onclick="toggleFilterButton(this)">üîß „Ç∑„Çπ„ÉÜ„É†</button>
                <button class="filter-btn active" data-filter="filterTest" onclick="toggleFilterButton(this)">üß™ „ÉÜ„Çπ„Éà</button>
            </div>
            
            <div style="margin-top: 15px;" id="vrchatLogTypeSection">
                <h5>üìä VRChat„É≠„Ç∞„Çø„Ç§„Éó„Éï„Ç£„É´„Çø„Éº</h5>
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="filterUserJoin" onclick="toggleFilterButton(this)">üëã „Éó„É¨„Ç§„É§„ÉºÂèÇÂä†</button>
                    <button class="filter-btn active" data-filter="filterUserLeave" onclick="toggleFilterButton(this)">üö∂ „Éó„É¨„Ç§„É§„ÉºÈÄÄÂá∫</button>
                    <button class="filter-btn active" data-filter="filterWorldChange" onclick="toggleFilterButton(this)">üåé „ÉØ„Éº„É´„ÉâÂ§âÊõ¥</button>
                    <button class="filter-btn active" data-filter="filterUnknown" onclick="toggleFilterButton(this)">‚ùì „Åù„ÅÆ‰ªñ</button>
                </div>
            </div>
            
            <div style="margin-top: 15px;" id="logLevelSection">
                <h5>üìä „É≠„Ç∞„É¨„Éô„É´„Éï„Ç£„É´„Çø„Éº</h5>
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="filterLevelInfo" onclick="toggleFilterButton(this)">‚ÑπÔ∏è Info</button>
                    <button class="filter-btn active" data-filter="filterLevelWarning" onclick="toggleFilterButton(this)">‚ö†Ô∏è Warning</button>
                    <button class="filter-btn active" data-filter="filterLevelError" onclick="toggleFilterButton(this)">‚ùå Error</button>
                    <button class="filter-btn active" data-filter="filterLevelOther" onclick="toggleFilterButton(this)">üìù „Åù„ÅÆ‰ªñ</button>
                </div>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    üîé „Ç≠„Éº„ÉØ„Éº„Éâ„Éï„Ç£„É´„Çø„Éº:
                    <input type="text" id="keywordFilter" placeholder="Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ..." 
                           style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px;" 
                           oninput="applyKeywordFilter()">
                </label>
                <button onclick="clearKeywordFilter()" style="padding: 4px 8px; font-size: 12px;">
                    üóëÔ∏è „ÇØ„É™„Ç¢
                </button>
            </div>
        </div>
        
        <div id="logArea" class="log-area">
            <div class="message">
                <span class="timestamp">„Ç∑„Çπ„ÉÜ„É†</span> - „É≠„Ç∞„Ç®„É™„Ç¢„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü
            </div>
        </div>
        
        <div class="info-section">
            <h3>üìä Êé•Á∂öÊÉÖÂ†±</h3>
            <p><strong>WebSocket„Çµ„Éº„Éê„Éº:</strong> <span id="wsUrl">ws://localhost:8080</span></p>
            <p><strong>HTTP„Çµ„Éº„Éê„Éº:</strong> <span id="httpUrl">http://localhost:3001</span></p>
            <p><strong>ÁèæÂú®ÊôÇÂàª:</strong> <span id="currentTime"></span></p>
            <p><strong>Êé•Á∂öÁä∂ÊÖã:</strong> <span id="connectionState">Êú™Êé•Á∂ö</span></p>
        </div>
        
        <div class="info-section">
            <h3>üìù ‰ΩøÁî®ÊñπÊ≥ï</h3>
            <ol>
                <li>„Äåüîó Êé•Á∂ö„Äç„Éú„Çø„É≥„ÅßWebSocket„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö</li>
                <li>VRChat„É≠„Ç∞„Éï„Ç°„Ç§„É´„Å´Â§âÊõ¥„Åå„ÅÇ„Çã„Å®Ëá™Âãï„Åß„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</li>
            </ol>
        </div>
    </div>

    <script>
        let ws = null;
        const statusDiv = document.getElementById('status');
        const logArea = document.getElementById('logArea');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionState = document.getElementById('connectionState');
        const debugToggle = document.getElementById('debugToggle');

        let debugMode = false; // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅÆÁä∂ÊÖã
        let autoScrollEnabled = true; // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅÆÁä∂ÊÖã

        // „Éá„Éê„ÉÉ„Ç∞Áî®„ÅÆ„É≠„Ç∞Èñ¢Êï∞
        function debugLog(...args) {
            if (debugMode) {
                console.log(...args);
            }
        }

        // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„Ç™„É≥„Éª„Ç™„Éï„ÇíÂàá„ÇäÊõø„Åà
        function toggleAutoScroll() {
            const toggle = document.getElementById('autoScrollToggle');
            autoScrollEnabled = toggle.checked;
            addLog('„Ç∑„Çπ„ÉÜ„É†', `Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´: ${autoScrollEnabled ? 'ON' : 'OFF'}`, 'info');
            
            // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„Åå„Ç™„É≥„Å´„Å™„Å£„ÅüÂ†¥Âêà„ÄÅÂç≥Â∫ß„Å´ÊúÄ‰∏ãÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
            if (autoScrollEnabled) {
                // „Çà„ÇäÈÄü„ÅÑ„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„Åü„ÇÅ„Å´„ÄÅÁõ¥Êé•„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíË®≠ÂÆö
                logArea.scrollTop = logArea.scrollHeight;
                debugLog('Auto scroll toggle - immediate scroll to bottom');
            }
        }

        // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„ÇíÂÆüË°å
        function performAutoScroll() {
            if (autoScrollEnabled) {
                // requestAnimationFrame„Çí‰ΩøÁî®„Åó„Å¶„Çπ„É†„Éº„Ç∫„Å´„Çπ„ÇØ„É≠„Éº„É´
                const scrollToBottom = () => {
                    const targetScrollTop = logArea.scrollHeight - logArea.clientHeight;
                    const currentScrollTop = logArea.scrollTop;
                    const distance = targetScrollTop - currentScrollTop;
                    
                    // Ë∑ùÈõ¢„ÅåÂ§ß„Åç„ÅÑÂ†¥ÂêàÔºà200px‰ª•‰∏äÔºâ„ÅØÂç≥Â∫ß„Å´„Çπ„ÇØ„É≠„Éº„É´
                    if (Math.abs(distance) > 200) {
                        logArea.scrollTop = targetScrollTop;
                        debugLog('Auto scroll completed (instant for large distance)');
                        return;
                    }
                    
                    if (Math.abs(distance) < 2) {
                        // ÂçÅÂàÜËøë„ÅÑÂ†¥Âêà„ÅØÁõ¥Êé•Ë®≠ÂÆö
                        logArea.scrollTop = targetScrollTop;
                        debugLog('Auto scroll completed');
                        return;
                    }
                    
                    // ÊÆµÈöéÁöÑ„Å´„Çπ„ÇØ„É≠„Éº„É´Ôºà„Çà„ÇäÈÄü„ÅÑ„Ç§„Éº„Ç∏„É≥„Ç∞ÂäπÊûúÔºâ
                    const step = distance * 0.6; // 60%„Åö„Å§ÁßªÂãïÔºà„Çà„ÇäÈÄü„ÅèÔºâ
                    logArea.scrollTop = currentScrollTop + step;
                    
                    // Ê¨°„ÅÆ„Éï„É¨„Éº„É†„ÅßÁ∂öË°å
                    requestAnimationFrame(scrollToBottom);
                };
                
                // DOMÊõ¥Êñ∞Âæå„Åô„Åê„Å´„Çπ„ÇØ„É≠„Éº„É´ÂÆüË°å
                setTimeout(() => {
                    scrollToBottom();
                }, 10); // ÈÅÖÂª∂„Çí50ms„Åã„Çâ10ms„Å´Áü≠Á∏Æ
                
                debugLog('Auto scroll initiated');
            } else {
                debugLog('Auto scroll skipped - disabled');
            }
        }

        // ÂãïÁöÑ„Å´WebSocket URL„ÇíÁîüÊàê
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}`;
        const httpUrl = `${window.location.protocol}//${window.location.host}`;
        
        // URLÊÉÖÂ†±„ÇíË°®Á§∫
        document.getElementById('wsUrl').textContent = wsUrl;
        document.getElementById('httpUrl').textContent = httpUrl;

        // ÁèæÂú®ÊôÇÂàª„ÇíË°®Á§∫
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('ja-JP');
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        // ÂàùÊúüÂåñÊôÇ„Å´VRChat„Éï„Ç£„É´„Çø„Éº„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÁä∂ÊÖã„ÇíË®≠ÂÆö
        updateVRChatFilterSections();

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                debugLog('Already connected');
                addLog('„Ç∑„Çπ„ÉÜ„É†', 'Êó¢„Å´Êé•Á∂öÊ∏à„Åø„Åß„Åô', 'info');
                return;
            }

            addLog('„Ç∑„Çπ„ÉÜ„É†', 'WebSocket„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö‰∏≠...', 'info');
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                debugLog('WebSocket connected');
                statusDiv.textContent = '‚úÖ Êé•Á∂ö‰∏≠';
                statusDiv.className = 'status connected';
                connectionState.textContent = 'Êé•Á∂ö‰∏≠';
                connectionState.className = 'success';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                addLog('„Ç∑„Çπ„ÉÜ„É†', 'WebSocket„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü', 'success');
            };

            ws.onmessage = function(event) {
                debugLog('Message received:', event.data);
                try {
                    const message = JSON.parse(event.data);
                    debugLog('Parsed message:', message); // „É°„ÉÉ„Çª„Éº„Ç∏ÊßãÈÄ†„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ
                    addFormattedLogMessage(message);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                    addLog('RAW', event.data, 'raw');
                }
            };

            ws.onclose = function(event) {
                debugLog('WebSocket closed', event);
                statusDiv.textContent = '‚ùå ÂàáÊñ≠';
                statusDiv.className = 'status disconnected';
                connectionState.textContent = 'ÂàáÊñ≠';
                connectionState.className = 'error';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                addLog('„Ç∑„Çπ„ÉÜ„É†', `WebSocketÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü („Ç≥„Éº„Éâ: ${event.code})`, 'error');
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLog('„Ç®„É©„Éº', 'WebSocketÊé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                addLog('„Ç∑„Çπ„ÉÜ„É†', 'WebSocketÊé•Á∂ö„ÇíÂàáÊñ≠„Åó„Åæ„Åó„Åü', 'info');
            }
        }

        function addFormattedLogMessage(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'message';
            
            const messageType = message.type || '„É°„ÉÉ„Çª„Éº„Ç∏';
            
            // „É°„ÉÉ„Çª„Éº„Ç∏„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶Ëâ≤„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíË®≠ÂÆö
            let color = '#007bff';
            let icon = 'üìù';
            let typeLabel = messageType;
            
            switch(messageType) {
                case 'vrchat_status_change':
                    color = '#28a745';
                    icon = 'üéÆ';
                    typeLabel = 'VRChat„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥';
                    break;
                case 'log_message':
                    // VRChat„É≠„Ç∞„ÅÆÂ†¥Âêà„ÄÅ„Éë„Éº„Çπ„Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„Ç¢„Ç§„Ç≥„É≥„Å®Ëâ≤„ÇíÂ§âÊõ¥
                    // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÊßãÈÄ†„Å´ÂØæÂøúÔºömessage.data.parsed „Åæ„Åü„ÅØ message.parsed
                    const parsedData = message.data?.parsed || message.parsed;
                    if (parsedData && parsedData.type) {
                        const parsedType = parsedData.type;
                        switch(parsedType) {
                            case 'user_join':
                                color = '#28a745';
                                icon = 'üëã';
                                typeLabel = '„Éó„É¨„Ç§„É§„ÉºÂèÇÂä†';
                                break;
                            case 'user_leave':
                                color = '#ffc107';
                                icon = 'üö∂';
                                typeLabel = '„Éó„É¨„Ç§„É§„ÉºÈÄÄÂá∫';
                                break;
                            case 'world_change':
                                color = '#6f42c1';
                                icon = 'üåé';
                                typeLabel = '„ÉØ„Éº„É´„ÉâÂ§âÊõ¥';
                                break;
                            case 'other':
                                color = '#6c757d';
                                icon = '‚ùì';
                                typeLabel = '„Åù„ÅÆ‰ªñ„É≠„Ç∞';
                                break;
                            default:
                                color = '#17a2b8';
                                icon = 'üìã';
                                typeLabel = 'VRChat„É≠„Ç∞';
                                break;
                        }
                    } else {
                        color = '#17a2b8';
                        icon = 'üìã';
                        typeLabel = 'VRChat„É≠„Ç∞';
                    }
                    break;
                case 'error':
                    color = '#dc3545';
                    icon = '‚ùå';
                    typeLabel = '„Ç®„É©„Éº';
                    break;
                case 'test':
                    color = '#6f42c1';
                    icon = 'üß™';
                    typeLabel = '„ÉÜ„Çπ„Éà';
                    break;
            }
            
            logEntry.style.borderLeftColor = color;
            logEntry.setAttribute('data-message-type', messageType);
            
            // VRChat„É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÄÅ„Éá„Éº„ÇøÂ±ûÊÄß„ÇíË®≠ÂÆö
            if (messageType === 'log_message' && message.data) {
                // „É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπ„Çí„Éá„Éº„ÇøÂ±ûÊÄß„Å®„Åó„Å¶‰øùÂ≠òÔºàÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
                if (message.data.message) {
                    logEntry.setAttribute('data-message-content', message.data.message);
                }
                
                // „É≠„Ç∞„É¨„Éô„É´„Çí„Éá„Éº„ÇøÂ±ûÊÄß„Å®„Åó„Å¶Ë®≠ÂÆö
                if (message.data.raw && message.data.raw.level) {
                    logEntry.setAttribute('data-log-level', message.data.raw.level.toLowerCase());
                } else {
                    logEntry.setAttribute('data-log-level', 'other');
                }
                
                // „Éë„Éº„ÇπÁµêÊûú„ÅÆ„Çø„Ç§„Éó„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Éá„Éº„ÇøÂ±ûÊÄß„Å´Ë®≠ÂÆö
                // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÊßãÈÄ†„Å´ÂØæÂøúÔºömessage.data.parsed „Åæ„Åü„ÅØ message.parsed
                const parsedData = message.data.parsed || message.parsed;
                if (parsedData && parsedData.type) {
                    logEntry.setAttribute('data-parsed-type', parsedData.type);
                    
                    // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞
                    if (debugMode) {
                        console.log('Setting data-parsed-type:', parsedData.type, 'for message:', message);
                    }
                } else {
                    // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞
                    if (debugMode) {
                        console.log('No parsed type found for message:', message);
                    }
                }
            } else {
                // ÈùûVRChat„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅÆ„É≠„Ç∞„É¨„Éô„É´„ÇíË®≠ÂÆö
                logEntry.setAttribute('data-log-level', 'other');
            }
            
            // „Éò„ÉÉ„ÉÄ„ÉºÈÉ®ÂàÜÔºà„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Å®„Çø„Ç§„ÉóÔºâ
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            
            // VRChat„É≠„Ç∞„ÅÆÂ†¥Âêà„ÅØlogData„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Çí‰ΩøÁî®
            if (messageType === 'log_message' && message.data) {
                const logData = message.data;
                if (logData.raw && logData.raw.timestamp) {
                    timestamp.textContent = new Date(logData.raw.timestamp).toLocaleTimeString('ja-JP');
                } else if (logData.timestamp) {
                    timestamp.textContent = new Date(logData.timestamp).toLocaleTimeString('ja-JP');
                } else {
                    timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
                }
            } else {
                timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
            }
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'message-type';
            typeSpan.innerHTML = `${icon} ${typeLabel}`;
            typeSpan.style.color = color;
            
            headerDiv.appendChild(timestamp);
            
            // „É≠„Ç∞„É¨„Éô„É´„Éê„ÉÉ„Ç∏„ÇíËøΩÂä†ÔºàVRChat„É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (messageType === 'log_message' && message.data && message.data.raw && message.data.raw.level) {
                const level = message.data.raw.level.toLowerCase();
                const levelBadge = document.createElement('span');
                levelBadge.className = 'level-badge';
                levelBadge.textContent = message.data.raw.level;
                levelBadge.style.marginLeft = '8px';
                levelBadge.style.marginRight = '8px';
                levelBadge.style.padding = '2px 8px';
                levelBadge.style.borderRadius = '12px';
                levelBadge.style.fontSize = '11px';
                levelBadge.style.fontWeight = 'bold';
                levelBadge.style.textTransform = 'uppercase';
                
                // „É¨„Éô„É´„Å´Âøú„Åò„ÅüËâ≤Ë®≠ÂÆö
                switch(level) {
                    case 'info':
                        levelBadge.style.backgroundColor = '#e3f2fd';
                        levelBadge.style.color = '#1976d2';
                        break;
                    case 'warning':
                    case 'warn':
                        levelBadge.style.backgroundColor = '#fff8e1';
                        levelBadge.style.color = '#f57c00';
                        break;
                    case 'error':
                        levelBadge.style.backgroundColor = '#ffebee';
                        levelBadge.style.color = '#d32f2f';
                        break;
                    default:
                        levelBadge.style.backgroundColor = '#f5f5f5';
                        levelBadge.style.color = '#666';
                        break;
                }
                
                headerDiv.appendChild(levelBadge);
            }
            
            headerDiv.appendChild(typeSpan);
            
            // „É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπÈÉ®ÂàÜ
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (messageType === 'log_message' && message.data) {
                // VRChat„É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà
                const logData = message.data;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                // ÂÖÉ„ÅÆ„É≠„Ç∞Ë°åÔºàraw„Éá„Éº„Çø„Åã„ÇâÂèñÂæóÔºâ- „É©„Éô„É´„Å™„Åó
                if (logData.raw && logData.raw.content) {
                    const codeDiv = document.createElement('div');
                    codeDiv.className = 'log-code';
                    codeDiv.textContent = logData.raw.content;
                    codeDiv.style.margin = '6px 0 3px 0';
                    
                    detailsDiv.appendChild(codeDiv);
                }
                
                // „É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπÔºàÂá¶ÁêÜÊ∏à„ÅøÔºâ- ÂÖÉ„ÅÆ„É≠„Ç∞Ë°å„Å®Áï∞„Å™„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                if (logData.message && logData.message !== (logData.raw && logData.raw.content)) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'log-code';
                    messageDiv.textContent = logData.message;
                    messageDiv.style.margin = '3px 0';
                    messageDiv.style.backgroundColor = '#e8f4fd';
                    messageDiv.style.borderLeft = '3px solid #007bff';
                    messageDiv.style.paddingLeft = '10px';
                    
                    detailsDiv.appendChild(messageDiv);
                }
                
                // „Éë„Éº„ÇπÊ∏à„ÅøÊÉÖÂ†±Ôºà„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÊßãÈÄ†„Å´ÂØæÂøúÔºâ
                // data-parsed-typeÂ±ûÊÄß„ÅÆË®≠ÂÆö„Å®Âêå„ÅòÊñπÊ≥ï„ÅßÂèñÂæó
                const parsedData = message.data.parsed || message.parsed;
                if (parsedData && Object.keys(parsedData).length > 0 && parsedData.type !== 'other') {
                    const parsedField = document.createElement('div');
                    parsedField.className = 'log-field';
                    
                    // „Éë„Éº„Çπ„Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Ç¢„Ç§„Ç≥„É≥„Å®„É©„Éô„É´„ÇíË®≠ÂÆö
                    let parsedIcon = '‚öôÔ∏è';
                    let parsedLabel = 'Ëß£ÊûêÁµêÊûú';
                    
                    if (parsedData.type) {
                        switch(parsedData.type) {
                            case 'user_join':
                                parsedIcon = 'üëã';
                                parsedLabel = '„Éó„É¨„Ç§„É§„ÉºÂèÇÂä†ÊÉÖÂ†±';
                                break;
                            case 'user_leave':
                                parsedIcon = 'üö∂';
                                parsedLabel = '„Éó„É¨„Ç§„É§„ÉºÈÄÄÂá∫ÊÉÖÂ†±';
                                break;
                            case 'world_change':
                                parsedIcon = 'üåé';
                                parsedLabel = '„ÉØ„Éº„É´„ÉâÂ§âÊõ¥ÊÉÖÂ†±';
                                break;
                        }
                    }
                    
                    parsedField.innerHTML = `<strong>${parsedIcon} ${parsedLabel}:</strong>`;
                    
                    const parsedDiv = document.createElement('div');
                    parsedDiv.className = 'log-details';
                    parsedDiv.style.marginTop = '4px';
                    parsedDiv.style.backgroundColor = '#ffffff';
                    parsedDiv.style.border = '1px solid #dee2e6';
                    
                    // VRChat„ÅÆÁâπÂÆö„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüÁâπÂà•„Å™Ë°®Á§∫
                    if (parsedData.type && parsedData.data) {
                        switch(parsedData.type) {
                            case 'user_join':
                            case 'user_leave':
                                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂàÜ„Åã„Çä„ÇÑ„Åô„ÅèË°®Á§∫
                                if (parsedData.data.userName) {
                                    const userField = document.createElement('div');
                                    userField.className = 'log-field';
                                    userField.innerHTML = `<strong>üë§ „É¶„Éº„Ç∂„ÉºÂêç:</strong> <code style="background-color: #e3f2fd; padding: 3px 6px; border-radius: 3px; color: #1976d2;">${parsedData.data.userName}</code>`;
                                    parsedDiv.appendChild(userField);
                                }
                                if (parsedData.data.userId) {
                                    const idField = document.createElement('div');
                                    idField.className = 'log-field';
                                    idField.innerHTML = `<strong>üÜî „É¶„Éº„Ç∂„ÉºID:</strong> <code style="background-color: #f3e5f5; padding: 3px 6px; border-radius: 3px; color: #7b1fa2;">${parsedData.data.userId}</code>`;
                                    parsedDiv.appendChild(idField);
                                }
                                break;
                                
                            case 'world_change':
                                // „ÉØ„Éº„É´„ÉâÊÉÖÂ†±„ÇíÂàÜ„Åã„Çä„ÇÑ„Åô„ÅèË°®Á§∫
                                if (parsedData.data.worldId) {
                                    const worldField = document.createElement('div');
                                    worldField.className = 'log-field';
                                    worldField.innerHTML = `<strong>üåç „ÉØ„Éº„É´„ÉâID:</strong> <code style="background-color: #e8f5e8; padding: 3px 6px; border-radius: 3px; color: #2e7d32;">${parsedData.data.worldId}</code>`;
                                    parsedDiv.appendChild(worldField);
                                }
                                if (parsedData.data.instance) {
                                    const userField = document.createElement('div');
                                    userField.className = 'log-field';
                                    userField.innerHTML = `<strong>üåç „Ç§„É≥„Çπ„Çø„É≥„Çπ:</strong> <code style="background-color: #e8f4f5; padding: 3px 6px; border-radius: 3px; color: #1f4fa2;">${parsedData.data.instance}</code>`;
                                    parsedDiv.appendChild(userField);
                                }
                                if (parsedData.data.userId) {
                                    const userField = document.createElement('div');
                                    userField.className = 'log-field';
                                    userField.innerHTML = `<strong>üë§ „Ç§„É≥„Çπ„Çø„É≥„Çπ„Ç™„Éº„Éä„Éº:</strong> <code style="background-color: #f3e5f5; padding: 3px 6px; border-radius: 3px; color: #7b1fa2;">${parsedData.data.userId}</code>`;
                                    parsedDiv.appendChild(userField);
                                }
                                
                                if (parsedData.data.region) {
                                    const regionField = document.createElement('div');
                                    regionField.className = 'log-field';
                                    regionField.innerHTML = `<strong>üåè Âú∞Âüü:</strong> <code style="background-color: #fff3e0; padding: 3px 6px; border-radius: 3px; color: #f57c00;">${parsedData.data.region}</code>`;
                                    parsedDiv.appendChild(regionField);
                                }
                                break;
                                
                            default:
                                // „Åù„ÅÆ‰ªñ„ÅÆ„Çø„Ç§„Éó„ÅØÈÄöÂ∏∏„ÅÆË°®Á§∫
                                for (const [key, value] of Object.entries(parsedData.data)) {
                                    if (key !== 'timestamp') { // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅØÈô§Â§ñ
                                        const fieldDiv = document.createElement('div');
                                        fieldDiv.className = 'log-field';
                                        fieldDiv.innerHTML = `<strong>${key}:</strong> <code style="background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${value}</code>`;
                                        parsedDiv.appendChild(fieldDiv);
                                    }
                                }
                                break;
                        }
                    } else {
                        // „Éë„Éº„Çπ„Éá„Éº„Çø„ÅåÊ®ôÊ∫ñÂΩ¢Âºè„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆÈÄöÂ∏∏Ë°®Á§∫
                        for (const [key, value] of Object.entries(parsedData)) {
                            if (key !== 'timestamp') { // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅØÈô§Â§ñ
                                const fieldDiv = document.createElement('div');
                                fieldDiv.className = 'log-field';
                                fieldDiv.innerHTML = `<strong>${key}:</strong> <code style="background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${value}</code>`;
                                parsedDiv.appendChild(fieldDiv);
                            }
                        }
                    }
                    
                    parsedField.appendChild(parsedDiv);
                    detailsDiv.appendChild(parsedField);
                }
                
                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±: ÂÆåÂÖ®„Å™„É°„ÉÉ„Çª„Éº„Ç∏ÊßãÈÄ†ÔºàÂ∏∏„Å´‰ΩúÊàê„ÄÅË°®Á§∫„ÉªÈùûË°®Á§∫„ÅØCSS„ÅßÂà∂Âæ°Ôºâ
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>üîß „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(logData, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
                
            } else if (messageType === 'vrchat_status_change' && message.data) {
                // VRChat„Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„ÅÆÂ†¥Âêà
                const statusData = message.data;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                const statusField = document.createElement('div');
                statusField.className = 'log-field';
                
                // Áä∂ÊÖãÂ§âÊõ¥„ÅÆÁ®ÆÈ°û„Å´„Çà„ÇäË°®Á§∫ÂÜÖÂÆπ„ÇíË™øÊï¥
                let prevStatus = '‰∏çÊòé';
                let currStatus = '‰∏çÊòé';
                
                if (statusData.changeType === 'vrchat_process') {
                    // „Éó„É≠„Çª„ÇπÁä∂ÊÖãÂ§âÊõ¥„ÅÆÂ†¥Âêà
                    const processData = statusData.data;
                    prevStatus = processData.previousState ? 'ÂÆüË°å‰∏≠' : 'ÂÅúÊ≠¢‰∏≠';
                    currStatus = processData.isRunning ? 'ÂÆüË°å‰∏≠' : 'ÂÅúÊ≠¢‰∏≠';
                } else if (statusData.currentStatus) {
                    // ‰∏ÄËà¨ÁöÑ„Å™Áä∂ÊÖãÂ§âÊõ¥„ÅÆÂ†¥Âêà
                    if (typeof statusData.currentStatus === 'string') {
                        currStatus = statusData.currentStatus;
                    } else if (statusData.currentStatus.isRunning !== undefined) {
                        currStatus = statusData.currentStatus.isRunning ? 'ÂÆüË°å‰∏≠' : 'ÂÅúÊ≠¢‰∏≠';
                    }
                }
                
                statusField.innerHTML = `<strong>üîÑ „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥:</strong> <span style="color: #dc3545;">${prevStatus}</span> ‚Üí <span style="color: #28a745;">${currStatus}</span>`;
                detailsDiv.appendChild(statusField);
                
                // Â§âÊõ¥„Çø„Ç§„Éó„ÅÆË°®Á§∫
                if (statusData.changeType) {
                    const changeTypeField = document.createElement('div');
                    changeTypeField.className = 'log-field';
                    let changeTypeText = '';
                    switch (statusData.changeType) {
                        case 'vrchat_process':
                            changeTypeText = 'VRChat„Éó„É≠„Çª„Çπ';
                            break;
                        case 'log_directory':
                            changeTypeText = '„É≠„Ç∞„Éá„Ç£„É¨„ÇØ„Éà„É™';
                            break;
                        case 'log_monitoring':
                            changeTypeText = '„É≠„Ç∞Áõ£Ë¶ñ';
                            break;
                        default:
                            changeTypeText = statusData.changeType;
                    }
                    changeTypeField.innerHTML = `<strong>üìä Â§âÊõ¥„Çø„Ç§„Éó:</strong> ${changeTypeText}`;
                    detailsDiv.appendChild(changeTypeField);
                }
                
                if (statusData.processInfo) {
                    const processField = document.createElement('div');
                    processField.className = 'log-field';
                    processField.innerHTML = `<strong>üîß „Éó„É≠„Çª„ÇπÊÉÖÂ†±:</strong> PID ${statusData.processInfo.processId}, Ê§úÂá∫ÊñπÊ≥ï: ${statusData.processInfo.detectionMethod}`;
                    detailsDiv.appendChild(processField);
                }
                
                if (statusData.timestamp) {
                    const timeField = document.createElement('div');
                    timeField.className = 'log-field';
                    timeField.innerHTML = `<strong>üìÖ Â§âÊõ¥ÊôÇÂàª:</strong> ${new Date(statusData.timestamp).toLocaleString('ja-JP')}`;
                    detailsDiv.appendChild(timeField);
                }
                
                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±: ÂÆåÂÖ®„Å™„É°„ÉÉ„Çª„Éº„Ç∏ÊßãÈÄ†ÔºàÂ∏∏„Å´‰ΩúÊàê„ÄÅË°®Á§∫„ÉªÈùûË°®Á§∫„ÅØCSS„ÅßÂà∂Âæ°Ôºâ
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>üîß „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(statusData, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
                
            } else {
                // „Åù„ÅÆ‰ªñ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                const pre = document.createElement('pre');
                pre.style.background = '#ffffff';
                pre.style.border = '1px solid #dee2e6';
                pre.style.borderRadius = '3px';
                pre.style.fontSize = '11px';
                pre.style.margin = '0';
                pre.style.padding = '8px';
                pre.style.whiteSpace = 'pre-wrap';
                pre.style.fontFamily = 'Courier New, Consolas, monospace';
                pre.textContent = JSON.stringify(message, null, 2);
                
                detailsDiv.appendChild(pre);
                
                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±: ÂÆåÂÖ®„Å™„É°„ÉÉ„Çª„Éº„Ç∏ÊßãÈÄ†ÔºàÂ∏∏„Å´‰ΩúÊàê„ÄÅË°®Á§∫„ÉªÈùûË°®Á§∫„ÅØCSS„ÅßÂà∂Âæ°Ôºâ
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>üîß „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(message, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
            }
            
            logEntry.appendChild(headerDiv);
            logEntry.appendChild(contentDiv);
            
            // „Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const shouldShow = shouldShowMessage(messageType, logEntry) && matchesKeywordFilter(logEntry);
            if (!shouldShow) {
                logEntry.style.display = 'none';
            }
            
            logArea.appendChild(logEntry);
            
            performAutoScroll();
        }

        function shouldShowMessage(messageType, element) {
            // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞
            if (debugMode) {
                console.log('shouldShowMessage called:', { messageType, element: element?.getAttribute?.('data-parsed-type') });
            }
            
            // Âü∫Êú¨ÁöÑ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„Çø„Ç§„Éó„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            let shouldShow = true;
            
            switch(messageType) {
                case 'log_message':
                    shouldShow = document.getElementById('filterLog').checked;
                    break;
                case 'vrchat_status_change':
                    shouldShow = document.getElementById('filterStatus').checked;
                    break;
                case 'test':
                    shouldShow = document.getElementById('filterTest').checked;
                    break;
                default:
                    shouldShow = document.getElementById('filterSystem').checked;
                    break;
            }
            
            if (debugMode) {
                console.log('Basic filter result:', shouldShow);
            }
            
            // VRChat„É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØ„ÄÅÂü∫Êú¨„Éï„Ç£„É´„Çø„Éº„Å®VRChat„É≠„Ç∞„Çø„Ç§„Éó„Éï„Ç£„É´„Çø„Éº„ÅÆ‰∏°Êñπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (messageType === 'log_message' && element) {
                const parsedType = element.getAttribute('data-parsed-type');
                if (debugMode) {
                    console.log('Parsed type:', parsedType);
                }
                
                // Âü∫Êú¨ÁöÑ„Å™„É≠„Ç∞„Éï„Ç£„É´„Çø„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const basicLogFilter = document.getElementById('filterLog').checked;
                
                // VRChat„É≠„Ç∞„Çø„Ç§„Éó„Éï„Ç£„É´„Çø„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                let specificShow = false;
                if (parsedType) {
                    switch(parsedType) {
                        case 'user_join':
                            specificShow = document.getElementById('filterUserJoin').checked;
                            break;
                        case 'user_leave':
                            specificShow = document.getElementById('filterUserLeave').checked;
                            break;
                        case 'world_change':
                            specificShow = document.getElementById('filterWorldChange').checked;
                            break;
                        case 'other':
                            specificShow = document.getElementById('filterUnknown').checked;
                            break;
                        default:
                            specificShow = document.getElementById('filterUnknown').checked;
                            break;
                    }
                } else {
                    // „Éë„Éº„Çπ„Çø„Ç§„Éó„Åå‰∏çÊòé„Å™Â†¥Âêà„ÅØ„Äå„Åù„ÅÆ‰ªñ„Éª‰∏çÊòé„Äç„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
                    specificShow = document.getElementById('filterUnknown').checked;
                }
                
                if (debugMode) {
                    console.log('VRChat log filter check:', {
                        basicLogFilter,
                        specificShow,
                        parsedType,
                        finalResult: basicLogFilter && specificShow
                    });
                }
                
                // Âü∫Êú¨„É≠„Ç∞„Éï„Ç£„É´„Çø„Éº„Å®VRChat„É≠„Ç∞„Çø„Ç§„Éó„Éï„Ç£„É´„Çø„Éº„ÅÆ‰∏°Êñπ„ÅåON„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
                shouldShow = basicLogFilter && specificShow;
            }
            
            // „É≠„Ç∞„É¨„Éô„É´„Éï„Ç£„É´„Çø„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÖ®„É°„ÉÉ„Çª„Éº„Ç∏ÂØæË±°Ôºâ
            if (shouldShow && element) {
                const logLevel = element.getAttribute('data-log-level') || 'other';
                let levelShow = false;
                
                switch(logLevel) {
                    case 'info':
                        levelShow = document.getElementById('filterLevelInfo').checked;
                        break;
                    case 'warning':
                    case 'warn':
                        levelShow = document.getElementById('filterLevelWarning').checked;
                        break;
                    case 'error':
                        levelShow = document.getElementById('filterLevelError').checked;
                        break;
                    default:
                        levelShow = document.getElementById('filterLevelOther').checked;
                        break;
                }
                
                if (debugMode) {
                    console.log('Log level filter check:', {
                        logLevel,
                        levelShow,
                        finalResult: shouldShow && levelShow
                    });
                }
                
                shouldShow = shouldShow && levelShow;
            }
            
            if (debugMode) {
                console.log('Final result:', shouldShow);
            }
            
            return shouldShow;
        }

        function matchesKeywordFilter(messageElement) {
            const keywordInput = document.getElementById('keywordFilter');
            const keyword = keywordInput.value.trim().toLowerCase();
            
            if (!keyword) {
                return true; // „Ç≠„Éº„ÉØ„Éº„Éâ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÂÖ®„Å¶Ë°®Á§∫
            }
            
            // „É°„ÉÉ„Çª„Éº„Ç∏„Çø„Ç§„Éó„ÇíÂèñÂæó
            const messageType = messageElement.getAttribute('data-message-type');
            
            // VRChat„É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÄÅlogData.message„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            if (messageType === 'log_message') {
                // „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂÆüÈöõ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊ†ºÁ¥ç„Åô„ÇãÈö†„Åó„Éá„Éº„ÇøÂ±ûÊÄß„ÇíËøΩÂä†‰∫àÂÆö
                const messageContent = messageElement.getAttribute('data-message-content');
                if (messageContent) {
                    return messageContent.toLowerCase().includes(keyword);
                }
            }
            
            // „Åù„ÅÆ‰ªñ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂ†¥Âêà„ÄÅË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„ÉÜ„Ç≠„Çπ„ÉàÂÖ®‰Ωì„ÅßÊ§úÁ¥¢
            const textContent = messageElement.textContent.toLowerCase();
            return textContent.includes(keyword);
        }

        function applyFilters() {
            const messages = logArea.querySelectorAll('.message');
            if (debugMode) {
                console.log('Applying filters to', messages.length, 'messages');
            }
            
            messages.forEach(message => {
                const messageType = message.getAttribute('data-message-type') || 'system';
                const typeMatches = shouldShowMessage(messageType, message);
                const keywordMatches = matchesKeywordFilter(message);
                
                if (debugMode) {
                    console.log('Message filter check:', {
                        messageType,
                        typeMatches,
                        keywordMatches,
                        parsedType: message.getAttribute('data-parsed-type')
                    });
                }
                
                if (typeMatches && keywordMatches) {
                    message.style.display = 'block';
                } else {
                    message.style.display = 'none';
                }
            });
        }

        function toggleFilter() {
            applyFilters();
        }

        function toggleFilterButton(button) {
            // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà
            button.classList.toggle('active');
            
            // ÂØæÂøú„Åô„Çãcheckbox„ÇíÊõ¥Êñ∞ÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
            const filterId = button.getAttribute('data-filter');
            const checkbox = document.getElementById(filterId);
            if (checkbox) {
                checkbox.checked = button.classList.contains('active');
            }
            
            // VRChat„É≠„Ç∞„Éï„Ç£„É´„Çø„Éº„ÅÆÂ†¥Âêà„ÄÅË©≥Á¥∞„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            if (filterId === 'filterLog') {
                updateVRChatFilterSections();
            }
            
            // „Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®
            applyFilters();
        }

        function syncButtonFromCheckbox(filterId) {
            // checkbox„ÅÆÁä∂ÊÖã„Å´Âêà„Çè„Åõ„Å¶„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            const checkbox = document.getElementById(filterId);
            const button = document.querySelector(`[data-filter="${filterId}"]`);
            
            if (checkbox && button) {
                if (checkbox.checked) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
            
            // VRChat„É≠„Ç∞„Éï„Ç£„É´„Çø„Éº„ÅÆÂ†¥Âêà„ÄÅË©≥Á¥∞„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            if (filterId === 'filterLog') {
                updateVRChatFilterSections();
            }
            
            applyFilters();
        }

        function updateVRChatFilterSections() {
            const vrchatLogButton = document.querySelector('[data-filter="filterLog"]');
            const vrchatLogTypeSection = document.getElementById('vrchatLogTypeSection');
            const logLevelSection = document.getElementById('logLevelSection');
            
            const isVRChatLogEnabled = vrchatLogButton && vrchatLogButton.classList.contains('active');
            
            if (isVRChatLogEnabled) {
                vrchatLogTypeSection.classList.remove('filter-section-disabled');
                logLevelSection.classList.remove('filter-section-disabled');
            } else {
                vrchatLogTypeSection.classList.add('filter-section-disabled');
                logLevelSection.classList.add('filter-section-disabled');
            }
        }

        function applyKeywordFilter() {
            applyFilters();
        }

        function clearKeywordFilter() {
            document.getElementById('keywordFilter').value = '';
            applyFilters();
        }

        function addLog(type, content, level = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = 'message';
            logEntry.setAttribute('data-message-type', 'system');
            logEntry.setAttribute('data-log-level', level);
            
            // „Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const shouldShow = shouldShowMessage('system', logEntry) && matchesKeywordFilter(logEntry);
            if (!shouldShow) {
                logEntry.style.display = 'none';
            }
            
            // „É¨„Éô„É´„Å´Âøú„Åò„Å¶Ëâ≤„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíË®≠ÂÆö
            let color = '#17a2b8';
            let icon = 'üîß';
            
            if (level === 'error') {
                color = '#dc3545';
                icon = '‚ùå';
            } else if (level === 'success') {
                color = '#28a745';
                icon = '‚úÖ';
            } else if (level === 'info') {
                color = '#17a2b8';
                icon = 'üîß';
            }
            
            logEntry.style.borderLeftColor = color;
            
            // „Éò„ÉÉ„ÉÄ„ÉºÈÉ®ÂàÜ
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'message-type';
            typeSpan.innerHTML = `${icon} ${type}`;
            typeSpan.style.color = color;
            
            headerDiv.appendChild(timestamp);
            headerDiv.appendChild(typeSpan);
            
            // „Ç≥„É≥„ÉÜ„É≥„ÉÑÈÉ®ÂàÜ
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'log-details';
            
            const contentField = document.createElement('div');
            contentField.className = 'log-field';
            contentField.textContent = content;
            detailsDiv.appendChild(contentField);
            
            contentDiv.appendChild(detailsDiv);
            
            logEntry.appendChild(headerDiv);
            logEntry.appendChild(contentDiv);
            
            logArea.appendChild(logEntry);
            
            performAutoScroll();
        }

        function clearLogs() {
            logArea.innerHTML = '';
            addLog('„Ç∑„Çπ„ÉÜ„É†', '„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'success');
        }

        function toggleDebug() {
            debugMode = debugToggle.checked;
            
            // Êó¢Â≠ò„ÅÆ„É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíË°®Á§∫„ÉªÈùûË°®Á§∫
            const debugInfoElements = logArea.querySelectorAll('.debug-info');
            debugInfoElements.forEach(element => {
                element.style.display = debugMode ? 'block' : 'none';
            });
            
            addLog('„Ç∑„Çπ„ÉÜ„É†', `„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ: ${debugMode ? 'ON' : 'OFF'}`, 'info');
            debugLog('Debug mode toggled:', debugMode);
        }

        function debugFilterElements() {
            const filterIds = [
                'filterLog', 'filterStatus', 'filterSystem', 'filterTest',
                'filterUserJoin', 'filterUserLeave', 'filterWorldChange', 
                'filterUdonEvent', 'filterUnknown',
                'filterLevelInfo', 'filterLevelWarning', 'filterLevelError', 'filterLevelOther'
            ];
            
            console.log('=== „Éï„Ç£„É´„ÇøË¶ÅÁ¥†„Éá„Éê„ÉÉ„Ç∞ ===');
            filterIds.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}:`, element ? `Â≠òÂú® (checked: ${element.checked})` : 'Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑ');
            });
            console.log('========================');
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        window.onload = function() {
            addLog('„Ç∑„Çπ„ÉÜ„É†', 'VRChat Log Relay Client„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü', 'success');
            addLog('„Ç∑„Çπ„ÉÜ„É†', '„Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åã„ÇâÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
            
            // „Éá„Éê„ÉÉ„Ç∞„Éà„Ç∞„É´„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
            if (debugToggle) {
                debugToggle.checked = debugMode;
                toggleDebug(); // ÂàùÊúüÁä∂ÊÖã„ÇíÈÅ©Áî®
            }
            
            // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´„Éà„Ç∞„É´„ÅÆÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
            const autoScrollToggle = document.getElementById('autoScrollToggle');
            if (autoScrollToggle) {
                autoScrollToggle.checked = autoScrollEnabled;
            }
            
            // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÄÅ„Éï„Ç£„É´„ÇøË¶ÅÁ¥†„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (debugMode) {
                debugFilterElements();
            }
        };

        // „Éö„Éº„Ç∏„ÇíÈõ¢„Çå„ÇãÊôÇ„Å´WebSocketÊé•Á∂ö„ÇíÈñâ„Åò„Çã
        window.onbeforeunload = function() {
            if (ws) {
                ws.close();
            }
        };

    </script>
</body>
</html>
