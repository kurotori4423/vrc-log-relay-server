<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRChat Log Relay Client</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            font-weight: bold;
            text-align: center;
        }
        .connected { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .disconnected { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .log-area { 
            border: 1px solid #ccc; 
            height: 1200px; 
            overflow-y: auto; 
            padding: 10px; 
            margin: 15px 0; 
            background-color: #f8f9fa; 
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            scroll-behavior: smooth;
            transition: scroll-top 0.3s ease-out;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        .message { 
            margin: 6px 0; 
            padding: 8px 12px; 
            border-left: 4px solid #007bff; 
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
        }
        .message:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .timestamp { 
            color: #6c757d; 
            font-size: 0.85em;
            font-weight: 500;
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e9ecef;
        }
        .message-type {
            margin-left: 10px;
            font-weight: bold;
        }
        .message-content {
            margin-top: 6px;
        }
        .log-details {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px;
            margin: 6px 0;
        }
        .log-field {
            margin: 3px 0;
            padding: 2px 0;
        }
        .log-field strong {
            color: #495057;
            min-width: 80px;
            display: inline-block;
        }
        .log-code {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 4px 6px;
            margin: 3px 0;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 12px;
            color: #495057;
            word-break: break-all;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid #e9ecef;
        }
        pre {
            background-color: #f8f9fa !important;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .info-section {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #dc3545;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .filter-group {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            margin-bottom: 5px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
            color: #6c757d;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 0;
            margin: 0;
            font-family: inherit;
        }

        .filter-btn:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }

        .filter-btn:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .filter-btn:not(:first-child) {
            border-left: none;
        }

        .filter-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .filter-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .filter-btn.active:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        
        /* ç„¡åŠ¹åŒ–çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .filter-section-disabled {
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .filter-section-disabled .filter-btn {
            cursor: not-allowed;
        }
        
        .filter-section-disabled h5 {
            color: #6c757d;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            margin: 5px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ VRChat Log Relay Client</h1>
        
        <div id="status" class="status disconnected">æœªæ¥ç¶š</div>
        
        <div>
            <button id="connectBtn" onclick="connect()">ğŸ”— æ¥ç¶š</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>ğŸ”Œ åˆ‡æ–­</button>
            <button onclick="clearLogs()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <label class="toggle-label">
                ğŸ› ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                <div class="toggle-switch">
                    <input type="checkbox" id="debugToggle" onchange="toggleDebug()">
                    <span class="toggle-slider"></span>
                </div>
            </label>
            <label class="toggle-label">
                ğŸ“œ è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                <div class="toggle-switch">
                    <input type="checkbox" id="autoScrollToggle" checked onchange="toggleAutoScroll()">
                    <span class="toggle-slider"></span>
                </div>
            </label>
        </div>
        
        <div class="info-section" style="margin: 15px 0;">
            <h4>ğŸ” ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h4>
            <!-- éš ã—checkboxï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰ -->
            <div style="display: none;">
                <input type="checkbox" id="filterLog" checked onchange="syncButtonFromCheckbox('filterLog')">
                <input type="checkbox" id="filterStatus" checked onchange="syncButtonFromCheckbox('filterStatus')">
                <input type="checkbox" id="filterSystem" checked onchange="syncButtonFromCheckbox('filterSystem')">
                <input type="checkbox" id="filterTest" checked onchange="syncButtonFromCheckbox('filterTest')">
                <input type="checkbox" id="filterUserJoin" checked onchange="syncButtonFromCheckbox('filterUserJoin')">
                <input type="checkbox" id="filterUserLeave" checked onchange="syncButtonFromCheckbox('filterUserLeave')">
                <input type="checkbox" id="filterWorldChange" checked onchange="syncButtonFromCheckbox('filterWorldChange')">
                <input type="checkbox" id="filterUnknown" checked onchange="syncButtonFromCheckbox('filterUnknown')">
                <input type="checkbox" id="filterLevelInfo" checked onchange="syncButtonFromCheckbox('filterLevelInfo')">
                <input type="checkbox" id="filterLevelWarning" checked onchange="syncButtonFromCheckbox('filterLevelWarning')">
                <input type="checkbox" id="filterLevelError" checked onchange="syncButtonFromCheckbox('filterLevelError')">
                <input type="checkbox" id="filterLevelOther" checked onchange="syncButtonFromCheckbox('filterLevelOther')">
            </div>
            <div class="filter-group">
                <button class="filter-btn active" data-filter="filterLog" onclick="toggleFilterButton(this)">ğŸ“‹ VRChatãƒ­ã‚°</button>
                <button class="filter-btn active" data-filter="filterStatus" onclick="toggleFilterButton(this)">ğŸ® ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</button>
                <button class="filter-btn active" data-filter="filterSystem" onclick="toggleFilterButton(this)">ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ </button>
                <button class="filter-btn active" data-filter="filterTest" onclick="toggleFilterButton(this)">ğŸ§ª ãƒ†ã‚¹ãƒˆ</button>
            </div>
            
            <div style="margin-top: 15px;" id="vrchatLogTypeSection">
                <h5>ğŸ“Š VRChatãƒ­ã‚°ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h5>
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="filterUserJoin" onclick="toggleFilterButton(this)">ğŸ‘‹ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ </button>
                    <button class="filter-btn active" data-filter="filterUserLeave" onclick="toggleFilterButton(this)">ğŸš¶ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€€å‡º</button>
                    <button class="filter-btn active" data-filter="filterWorldChange" onclick="toggleFilterButton(this)">ğŸŒ ãƒ¯ãƒ¼ãƒ«ãƒ‰å¤‰æ›´</button>
                    <button class="filter-btn active" data-filter="filterUnknown" onclick="toggleFilterButton(this)">â“ ãã®ä»–</button>
                </div>
            </div>
            
            <div style="margin-top: 15px;" id="logLevelSection">
                <h5>ğŸ“Š ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h5>
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="filterLevelInfo" onclick="toggleFilterButton(this)">â„¹ï¸ Info</button>
                    <button class="filter-btn active" data-filter="filterLevelWarning" onclick="toggleFilterButton(this)">âš ï¸ Warning</button>
                    <button class="filter-btn active" data-filter="filterLevelError" onclick="toggleFilterButton(this)">âŒ Error</button>
                    <button class="filter-btn active" data-filter="filterLevelOther" onclick="toggleFilterButton(this)">ğŸ“ ãã®ä»–</button>
                </div>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:
                    <input type="text" id="keywordFilter" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." 
                           style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px;" 
                           oninput="applyKeywordFilter()">
                </label>
                <button onclick="clearKeywordFilter()" style="padding: 4px 8px; font-size: 12px;">
                    ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
        
        <div id="logArea" class="log-area">
            <div class="message">
                <span class="timestamp">ã‚·ã‚¹ãƒ†ãƒ </span> - ãƒ­ã‚°ã‚¨ãƒªã‚¢ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ
            </div>
        </div>
        
        <div class="info-section">
            <h3>ğŸ“Š æ¥ç¶šæƒ…å ±</h3>
            <p><strong>WebSocketã‚µãƒ¼ãƒãƒ¼:</strong> <span id="wsUrl">ws://localhost:8080</span></p>
            <p><strong>HTTPã‚µãƒ¼ãƒãƒ¼:</strong> <span id="httpUrl">http://localhost:3001</span></p>
            <p><strong>ç¾åœ¨æ™‚åˆ»:</strong> <span id="currentTime"></span></p>
            <p><strong>æ¥ç¶šçŠ¶æ…‹:</strong> <span id="connectionState">æœªæ¥ç¶š</span></p>
        </div>
        
        <div class="info-section">
            <h3>ğŸ“ ä½¿ç”¨æ–¹æ³•</h3>
            <ol>
                <li>ã€ŒğŸ”— æ¥ç¶šã€ãƒœã‚¿ãƒ³ã§WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š</li>
                <li>VRChatãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã‚‹ã¨è‡ªå‹•ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
            </ol>
        </div>
    </div>

    <script>
        let ws = null;
        const statusDiv = document.getElementById('status');
        const logArea = document.getElementById('logArea');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionState = document.getElementById('connectionState');
        const debugToggle = document.getElementById('debugToggle');

        let debugMode = false; // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹
        let autoScrollEnabled = true; // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®çŠ¶æ…‹

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°é–¢æ•°
        function debugLog(...args) {
            if (debugMode) {
                console.log(...args);
            }
        }

        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ã‚ªãƒ³ãƒ»ã‚ªãƒ•ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleAutoScroll() {
            const toggle = document.getElementById('autoScrollToggle');
            autoScrollEnabled = toggle.checked;
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', `è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«: ${autoScrollEnabled ? 'ON' : 'OFF'}`, 'info');
            
            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒã‚ªãƒ³ã«ãªã£ãŸå ´åˆã€å³åº§ã«æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            if (autoScrollEnabled) {
                // ã‚ˆã‚Šé€Ÿã„ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãŸã‚ã«ã€ç›´æ¥ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®š
                logArea.scrollTop = logArea.scrollHeight;
                debugLog('Auto scroll toggle - immediate scroll to bottom');
            }
        }

        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ
        function performAutoScroll() {
            if (autoScrollEnabled) {
                // requestAnimationFrameã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                const scrollToBottom = () => {
                    const targetScrollTop = logArea.scrollHeight - logArea.clientHeight;
                    const currentScrollTop = logArea.scrollTop;
                    const distance = targetScrollTop - currentScrollTop;
                    
                    // è·é›¢ãŒå¤§ãã„å ´åˆï¼ˆ200pxä»¥ä¸Šï¼‰ã¯å³åº§ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    if (Math.abs(distance) > 200) {
                        logArea.scrollTop = targetScrollTop;
                        debugLog('Auto scroll completed (instant for large distance)');
                        return;
                    }
                    
                    if (Math.abs(distance) < 2) {
                        // ååˆ†è¿‘ã„å ´åˆã¯ç›´æ¥è¨­å®š
                        logArea.scrollTop = targetScrollTop;
                        debugLog('Auto scroll completed');
                        return;
                    }
                    
                    // æ®µéšçš„ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆã‚ˆã‚Šé€Ÿã„ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°åŠ¹æœï¼‰
                    const step = distance * 0.6; // 60%ãšã¤ç§»å‹•ï¼ˆã‚ˆã‚Šé€Ÿãï¼‰
                    logArea.scrollTop = currentScrollTop + step;
                    
                    // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ç¶šè¡Œ
                    requestAnimationFrame(scrollToBottom);
                };
                
                // DOMæ›´æ–°å¾Œã™ãã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
                setTimeout(() => {
                    scrollToBottom();
                }, 10); // é…å»¶ã‚’50msã‹ã‚‰10msã«çŸ­ç¸®
                
                debugLog('Auto scroll initiated');
            } else {
                debugLog('Auto scroll skipped - disabled');
            }
        }

        // å‹•çš„ã«WebSocket URLã‚’ç”Ÿæˆ
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}`;
        const httpUrl = `${window.location.protocol}//${window.location.host}`;
        
        // URLæƒ…å ±ã‚’è¡¨ç¤º
        document.getElementById('wsUrl').textContent = wsUrl;
        document.getElementById('httpUrl').textContent = httpUrl;

        // ç¾åœ¨æ™‚åˆ»ã‚’è¡¨ç¤º
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('ja-JP');
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        // åˆæœŸåŒ–æ™‚ã«VRChatãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’è¨­å®š
        updateVRChatFilterSections();

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                debugLog('Already connected');
                addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'æ—¢ã«æ¥ç¶šæ¸ˆã¿ã§ã™', 'info');
                return;
            }

            addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...', 'info');
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                debugLog('WebSocket connected');
                statusDiv.textContent = 'âœ… æ¥ç¶šä¸­';
                statusDiv.className = 'status connected';
                connectionState.textContent = 'æ¥ç¶šä¸­';
                connectionState.className = 'success';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ', 'success');
            };

            ws.onmessage = function(event) {
                debugLog('Message received:', event.data);
                try {
                    const message = JSON.parse(event.data);
                    debugLog('Parsed message:', message); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                    addFormattedLogMessage(message);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                    addLog('RAW', event.data, 'raw');
                }
            };

            ws.onclose = function(event) {
                debugLog('WebSocket closed', event);
                statusDiv.textContent = 'âŒ åˆ‡æ–­';
                statusDiv.className = 'status disconnected';
                connectionState.textContent = 'åˆ‡æ–­';
                connectionState.className = 'error';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                addLog('ã‚·ã‚¹ãƒ†ãƒ ', `WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ (ã‚³ãƒ¼ãƒ‰: ${event.code})`, 'error');
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLog('ã‚¨ãƒ©ãƒ¼', 'WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'WebSocketæ¥ç¶šã‚’åˆ‡æ–­ã—ã¾ã—ãŸ', 'info');
            }
        }

        function addFormattedLogMessage(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'message';
            
            const messageType = message.type || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
            let color = '#007bff';
            let icon = 'ğŸ“';
            let typeLabel = messageType;
            
            switch(messageType) {
                case 'vrchat_status_change':
                    color = '#28a745';
                    icon = 'ğŸ®';
                    typeLabel = 'VRChatã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´';
                    break;
                case 'log_message':
                    // VRChatãƒ­ã‚°ã®å ´åˆã€ãƒ‘ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚¢ã‚¤ã‚³ãƒ³ã¨è‰²ã‚’å¤‰æ›´
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ã«å¯¾å¿œï¼šmessage.data.parsed ã¾ãŸã¯ message.parsed
                    const parsedData = message.data?.parsed || message.parsed;
                    if (parsedData && parsedData.type) {
                        const parsedType = parsedData.type;
                        switch(parsedType) {
                            case 'user_join':
                                color = '#28a745';
                                icon = 'ğŸ‘‹';
                                typeLabel = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ ';
                                break;
                            case 'user_leave':
                                color = '#ffc107';
                                icon = 'ğŸš¶';
                                typeLabel = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€€å‡º';
                                break;
                            case 'world_change':
                                color = '#6f42c1';
                                icon = 'ğŸŒ';
                                typeLabel = 'ãƒ¯ãƒ¼ãƒ«ãƒ‰å¤‰æ›´';
                                break;
                            case 'other':
                                color = '#6c757d';
                                icon = 'â“';
                                typeLabel = 'ãã®ä»–ãƒ­ã‚°';
                                break;
                            default:
                                color = '#17a2b8';
                                icon = 'ğŸ“‹';
                                typeLabel = 'VRChatãƒ­ã‚°';
                                break;
                        }
                    } else {
                        color = '#17a2b8';
                        icon = 'ğŸ“‹';
                        typeLabel = 'VRChatãƒ­ã‚°';
                    }
                    break;
                case 'error':
                    color = '#dc3545';
                    icon = 'âŒ';
                    typeLabel = 'ã‚¨ãƒ©ãƒ¼';
                    break;
                case 'test':
                    color = '#6f42c1';
                    icon = 'ğŸ§ª';
                    typeLabel = 'ãƒ†ã‚¹ãƒˆ';
                    break;
            }
            
            logEntry.style.borderLeftColor = color;
            logEntry.setAttribute('data-message-type', messageType);
            
            // VRChatãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’è¨­å®š
            if (messageType === 'log_message' && message.data) {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿å­˜ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
                if (message.data.message) {
                    logEntry.setAttribute('data-message-content', message.data.message);
                }
                
                // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦è¨­å®š
                if (message.data.raw && message.data.raw.level) {
                    logEntry.setAttribute('data-log-level', message.data.raw.level.toLowerCase());
                } else {
                    logEntry.setAttribute('data-log-level', 'other');
                }
                
                // ãƒ‘ãƒ¼ã‚¹çµæœã®ã‚¿ã‚¤ãƒ—ãŒã‚ã‚‹å ´åˆã¯ãƒ‡ãƒ¼ã‚¿å±æ€§ã«è¨­å®š
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ã«å¯¾å¿œï¼šmessage.data.parsed ã¾ãŸã¯ message.parsed
                const parsedData = message.data.parsed || message.parsed;
                if (parsedData && parsedData.type) {
                    logEntry.setAttribute('data-parsed-type', parsedData.type);
                    
                    // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                    if (debugMode) {
                        console.log('Setting data-parsed-type:', parsedData.type, 'for message:', message);
                    }
                } else {
                    // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
                    if (debugMode) {
                        console.log('No parsed type found for message:', message);
                    }
                }
            } else {
                // éVRChatãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š
                logEntry.setAttribute('data-log-level', 'other');
            }
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã‚¿ã‚¤ãƒ—ï¼‰
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            
            // VRChatãƒ­ã‚°ã®å ´åˆã¯logDataã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨
            if (messageType === 'log_message' && message.data) {
                const logData = message.data;
                if (logData.raw && logData.raw.timestamp) {
                    timestamp.textContent = new Date(logData.raw.timestamp).toLocaleTimeString('ja-JP');
                } else if (logData.timestamp) {
                    timestamp.textContent = new Date(logData.timestamp).toLocaleTimeString('ja-JP');
                } else {
                    timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
                }
            } else {
                timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
            }
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'message-type';
            typeSpan.innerHTML = `${icon} ${typeLabel}`;
            typeSpan.style.color = color;
            
            headerDiv.appendChild(timestamp);
            
            // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆVRChatãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã®ã¿ï¼‰
            if (messageType === 'log_message' && message.data && message.data.raw && message.data.raw.level) {
                const level = message.data.raw.level.toLowerCase();
                const levelBadge = document.createElement('span');
                levelBadge.className = 'level-badge';
                levelBadge.textContent = message.data.raw.level;
                levelBadge.style.marginLeft = '8px';
                levelBadge.style.marginRight = '8px';
                levelBadge.style.padding = '2px 8px';
                levelBadge.style.borderRadius = '12px';
                levelBadge.style.fontSize = '11px';
                levelBadge.style.fontWeight = 'bold';
                levelBadge.style.textTransform = 'uppercase';
                
                // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè‰²è¨­å®š
                switch(level) {
                    case 'info':
                        levelBadge.style.backgroundColor = '#e3f2fd';
                        levelBadge.style.color = '#1976d2';
                        break;
                    case 'warning':
                    case 'warn':
                        levelBadge.style.backgroundColor = '#fff8e1';
                        levelBadge.style.color = '#f57c00';
                        break;
                    case 'error':
                        levelBadge.style.backgroundColor = '#ffebee';
                        levelBadge.style.color = '#d32f2f';
                        break;
                    default:
                        levelBadge.style.backgroundColor = '#f5f5f5';
                        levelBadge.style.color = '#666';
                        break;
                }
                
                headerDiv.appendChild(levelBadge);
            }
            
            headerDiv.appendChild(typeSpan);
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹éƒ¨åˆ†
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (messageType === 'log_message' && message.data) {
                // VRChatãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
                const logData = message.data;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                // å…ƒã®ãƒ­ã‚°è¡Œï¼ˆrawãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰- ãƒ©ãƒ™ãƒ«ãªã—
                if (logData.raw && logData.raw.content) {
                    const codeDiv = document.createElement('div');
                    codeDiv.className = 'log-code';
                    codeDiv.textContent = logData.raw.content;
                    codeDiv.style.margin = '6px 0 3px 0';
                    
                    detailsDiv.appendChild(codeDiv);
                }
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ï¼ˆå‡¦ç†æ¸ˆã¿ï¼‰- å…ƒã®ãƒ­ã‚°è¡Œã¨ç•°ãªã‚‹å ´åˆã®ã¿è¡¨ç¤º
                if (logData.message && logData.message !== (logData.raw && logData.raw.content)) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'log-code';
                    messageDiv.textContent = logData.message;
                    messageDiv.style.margin = '3px 0';
                    messageDiv.style.backgroundColor = '#e8f4fd';
                    messageDiv.style.borderLeft = '3px solid #007bff';
                    messageDiv.style.paddingLeft = '10px';
                    
                    detailsDiv.appendChild(messageDiv);
                }
                
                // ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿æƒ…å ±ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ã«å¯¾å¿œï¼‰
                // data-parsed-typeå±æ€§ã®è¨­å®šã¨åŒã˜æ–¹æ³•ã§å–å¾—
                const parsedData = message.data.parsed || message.parsed;
                if (parsedData && Object.keys(parsedData).length > 0 && parsedData.type !== 'other') {
                    const parsedField = document.createElement('div');
                    parsedField.className = 'log-field';
                    
                    // ãƒ‘ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ©ãƒ™ãƒ«ã‚’è¨­å®š
                    let parsedIcon = 'âš™ï¸';
                    let parsedLabel = 'è§£æçµæœ';
                    
                    if (parsedData.type) {
                        switch(parsedData.type) {
                            case 'user_join':
                                parsedIcon = 'ğŸ‘‹';
                                parsedLabel = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ æƒ…å ±';
                                break;
                            case 'user_leave':
                                parsedIcon = 'ğŸš¶';
                                parsedLabel = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€€å‡ºæƒ…å ±';
                                break;
                            case 'world_change':
                                parsedIcon = 'ğŸŒ';
                                parsedLabel = 'ãƒ¯ãƒ¼ãƒ«ãƒ‰å¤‰æ›´æƒ…å ±';
                                break;
                        }
                    }
                    
                    parsedField.innerHTML = `<strong>${parsedIcon} ${parsedLabel}:</strong>`;
                    
                    const parsedDiv = document.createElement('div');
                    parsedDiv.className = 'log-details';
                    parsedDiv.style.marginTop = '4px';
                    parsedDiv.style.backgroundColor = '#ffffff';
                    parsedDiv.style.border = '1px solid #dee2e6';
                    
                    // VRChatã®ç‰¹å®šã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸç‰¹åˆ¥ãªè¡¨ç¤º
                    if (parsedData.type && parsedData.data) {
                        switch(parsedData.type) {
                            case 'user_join':
                            case 'user_leave':
                                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
                                if (parsedData.data.userName) {
                                    const userField = document.createElement('div');
                                    userField.className = 'log-field';
                                    userField.innerHTML = `<strong>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> <code style="background-color: #e3f2fd; padding: 3px 6px; border-radius: 3px; color: #1976d2;">${parsedData.data.userName}</code>`;
                                    parsedDiv.appendChild(userField);
                                }
                                if (parsedData.data.userId) {
                                    const idField = document.createElement('div');
                                    idField.className = 'log-field';
                                    idField.innerHTML = `<strong>ğŸ†” ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> <code style="background-color: #f3e5f5; padding: 3px 6px; border-radius: 3px; color: #7b1fa2;">${parsedData.data.userId}</code>`;
                                    parsedDiv.appendChild(idField);
                                }
                                break;
                                
                            case 'world_change':
                                // ãƒ¯ãƒ¼ãƒ«ãƒ‰æƒ…å ±ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
                                if (parsedData.data.worldId) {
                                    const worldField = document.createElement('div');
                                    worldField.className = 'log-field';
                                    worldField.innerHTML = `<strong>ğŸŒ ãƒ¯ãƒ¼ãƒ«ãƒ‰ID:</strong> <code style="background-color: #e8f5e8; padding: 3px 6px; border-radius: 3px; color: #2e7d32;">${parsedData.data.worldId}</code>`;
                                    parsedDiv.appendChild(worldField);
                                }
                                if (parsedData.data.instance) {
                                    const userField = document.createElement('div');
                                    userField.className = 'log-field';
                                    userField.innerHTML = `<strong>ğŸŒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹:</strong> <code style="background-color: #e8f4f5; padding: 3px 6px; border-radius: 3px; color: #1f4fa2;">${parsedData.data.instance}</code>`;
                                    parsedDiv.appendChild(userField);
                                }
                                if (parsedData.data.userId) {
                                    const userField = document.createElement('div');
                                    userField.className = 'log-field';
                                    userField.innerHTML = `<strong>ğŸ‘¤ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼:</strong> <code style="background-color: #f3e5f5; padding: 3px 6px; border-radius: 3px; color: #7b1fa2;">${parsedData.data.userId}</code>`;
                                    parsedDiv.appendChild(userField);
                                }
                                
                                if (parsedData.data.region) {
                                    const regionField = document.createElement('div');
                                    regionField.className = 'log-field';
                                    regionField.innerHTML = `<strong>ğŸŒ åœ°åŸŸ:</strong> <code style="background-color: #fff3e0; padding: 3px 6px; border-radius: 3px; color: #f57c00;">${parsedData.data.region}</code>`;
                                    parsedDiv.appendChild(regionField);
                                }
                                break;
                                
                            default:
                                // ãã®ä»–ã®ã‚¿ã‚¤ãƒ—ã¯é€šå¸¸ã®è¡¨ç¤º
                                for (const [key, value] of Object.entries(parsedData.data)) {
                                    if (key !== 'timestamp') { // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯é™¤å¤–
                                        const fieldDiv = document.createElement('div');
                                        fieldDiv.className = 'log-field';
                                        fieldDiv.innerHTML = `<strong>${key}:</strong> <code style="background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${value}</code>`;
                                        parsedDiv.appendChild(fieldDiv);
                                    }
                                }
                                break;
                        }
                    } else {
                        // ãƒ‘ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒæ¨™æº–å½¢å¼ã§ãªã„å ´åˆã®é€šå¸¸è¡¨ç¤º
                        for (const [key, value] of Object.entries(parsedData)) {
                            if (key !== 'timestamp') { // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯é™¤å¤–
                                const fieldDiv = document.createElement('div');
                                fieldDiv.className = 'log-field';
                                fieldDiv.innerHTML = `<strong>${key}:</strong> <code style="background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${value}</code>`;
                                parsedDiv.appendChild(fieldDiv);
                            }
                        }
                    }
                    
                    parsedField.appendChild(parsedDiv);
                    detailsDiv.appendChild(parsedField);
                }
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±: å®Œå…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ï¼ˆå¸¸ã«ä½œæˆã€è¡¨ç¤ºãƒ»éè¡¨ç¤ºã¯CSSã§åˆ¶å¾¡ï¼‰
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(logData, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
                
            } else if (messageType === 'vrchat_status_change' && message.data) {
                // VRChatã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®å ´åˆ
                const statusData = message.data;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                const statusField = document.createElement('div');
                statusField.className = 'log-field';
                
                // çŠ¶æ…‹å¤‰æ›´ã®ç¨®é¡ã«ã‚ˆã‚Šè¡¨ç¤ºå†…å®¹ã‚’èª¿æ•´
                let prevStatus = 'ä¸æ˜';
                let currStatus = 'ä¸æ˜';
                
                if (statusData.changeType === 'vrchat_process') {
                    // ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹å¤‰æ›´ã®å ´åˆ
                    const processData = statusData.data;
                    prevStatus = processData.previousState ? 'å®Ÿè¡Œä¸­' : 'åœæ­¢ä¸­';
                    currStatus = processData.isRunning ? 'å®Ÿè¡Œä¸­' : 'åœæ­¢ä¸­';
                } else if (statusData.currentStatus) {
                    // ä¸€èˆ¬çš„ãªçŠ¶æ…‹å¤‰æ›´ã®å ´åˆ
                    if (typeof statusData.currentStatus === 'string') {
                        currStatus = statusData.currentStatus;
                    } else if (statusData.currentStatus.isRunning !== undefined) {
                        currStatus = statusData.currentStatus.isRunning ? 'å®Ÿè¡Œä¸­' : 'åœæ­¢ä¸­';
                    }
                }
                
                statusField.innerHTML = `<strong>ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´:</strong> <span style="color: #dc3545;">${prevStatus}</span> â†’ <span style="color: #28a745;">${currStatus}</span>`;
                detailsDiv.appendChild(statusField);
                
                // å¤‰æ›´ã‚¿ã‚¤ãƒ—ã®è¡¨ç¤º
                if (statusData.changeType) {
                    const changeTypeField = document.createElement('div');
                    changeTypeField.className = 'log-field';
                    let changeTypeText = '';
                    switch (statusData.changeType) {
                        case 'vrchat_process':
                            changeTypeText = 'VRChatãƒ—ãƒ­ã‚»ã‚¹';
                            break;
                        case 'log_directory':
                            changeTypeText = 'ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª';
                            break;
                        case 'log_monitoring':
                            changeTypeText = 'ãƒ­ã‚°ç›£è¦–';
                            break;
                        default:
                            changeTypeText = statusData.changeType;
                    }
                    changeTypeField.innerHTML = `<strong>ğŸ“Š å¤‰æ›´ã‚¿ã‚¤ãƒ—:</strong> ${changeTypeText}`;
                    detailsDiv.appendChild(changeTypeField);
                }
                
                if (statusData.processInfo) {
                    const processField = document.createElement('div');
                    processField.className = 'log-field';
                    processField.innerHTML = `<strong>ğŸ”§ ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±:</strong> PID ${statusData.processInfo.processId}, æ¤œå‡ºæ–¹æ³•: ${statusData.processInfo.detectionMethod}`;
                    detailsDiv.appendChild(processField);
                }
                
                if (statusData.timestamp) {
                    const timeField = document.createElement('div');
                    timeField.className = 'log-field';
                    timeField.innerHTML = `<strong>ğŸ“… å¤‰æ›´æ™‚åˆ»:</strong> ${new Date(statusData.timestamp).toLocaleString('ja-JP')}`;
                    detailsDiv.appendChild(timeField);
                }
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±: å®Œå…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ï¼ˆå¸¸ã«ä½œæˆã€è¡¨ç¤ºãƒ»éè¡¨ç¤ºã¯CSSã§åˆ¶å¾¡ï¼‰
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(statusData, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
                
            } else {
                // ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                const pre = document.createElement('pre');
                pre.style.background = '#ffffff';
                pre.style.border = '1px solid #dee2e6';
                pre.style.borderRadius = '3px';
                pre.style.fontSize = '11px';
                pre.style.margin = '0';
                pre.style.padding = '8px';
                pre.style.whiteSpace = 'pre-wrap';
                pre.style.fontFamily = 'Courier New, Consolas, monospace';
                pre.textContent = JSON.stringify(message, null, 2);
                
                detailsDiv.appendChild(pre);
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±: å®Œå…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ï¼ˆå¸¸ã«ä½œæˆã€è¡¨ç¤ºãƒ»éè¡¨ç¤ºã¯CSSã§åˆ¶å¾¡ï¼‰
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(message, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
            }
            
            logEntry.appendChild(headerDiv);
            logEntry.appendChild(contentDiv);
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯
            const shouldShow = shouldShowMessage(messageType, logEntry) && matchesKeywordFilter(logEntry);
            if (!shouldShow) {
                logEntry.style.display = 'none';
            }
            
            logArea.appendChild(logEntry);
            
            performAutoScroll();
        }

        function shouldShowMessage(messageType, element) {
            // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
            if (debugMode) {
                console.log('shouldShowMessage called:', { messageType, element: element?.getAttribute?.('data-parsed-type') });
            }
            
            // åŸºæœ¬çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let shouldShow = true;
            
            switch(messageType) {
                case 'log_message':
                    shouldShow = document.getElementById('filterLog').checked;
                    break;
                case 'vrchat_status_change':
                    shouldShow = document.getElementById('filterStatus').checked;
                    break;
                case 'test':
                    shouldShow = document.getElementById('filterTest').checked;
                    break;
                default:
                    shouldShow = document.getElementById('filterSystem').checked;
                    break;
            }
            
            if (debugMode) {
                console.log('Basic filter result:', shouldShow);
            }
            
            // VRChatãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ã€åŸºæœ¬ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨VRChatãƒ­ã‚°ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
            if (messageType === 'log_message' && element) {
                const parsedType = element.getAttribute('data-parsed-type');
                if (debugMode) {
                    console.log('Parsed type:', parsedType);
                }
                
                // åŸºæœ¬çš„ãªãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                const basicLogFilter = document.getElementById('filterLog').checked;
                
                // VRChatãƒ­ã‚°ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                let specificShow = false;
                if (parsedType) {
                    switch(parsedType) {
                        case 'user_join':
                            specificShow = document.getElementById('filterUserJoin').checked;
                            break;
                        case 'user_leave':
                            specificShow = document.getElementById('filterUserLeave').checked;
                            break;
                        case 'world_change':
                            specificShow = document.getElementById('filterWorldChange').checked;
                            break;
                        case 'other':
                            specificShow = document.getElementById('filterUnknown').checked;
                            break;
                        default:
                            specificShow = document.getElementById('filterUnknown').checked;
                            break;
                    }
                } else {
                    // ãƒ‘ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ãŒä¸æ˜ãªå ´åˆã¯ã€Œãã®ä»–ãƒ»ä¸æ˜ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
                    specificShow = document.getElementById('filterUnknown').checked;
                }
                
                if (debugMode) {
                    console.log('VRChat log filter check:', {
                        basicLogFilter,
                        specificShow,
                        parsedType,
                        finalResult: basicLogFilter && specificShow
                    });
                }
                
                // åŸºæœ¬ãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨VRChatãƒ­ã‚°ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ä¸¡æ–¹ãŒONã®å ´åˆã®ã¿è¡¨ç¤º
                shouldShow = basicLogFilter && specificShow;
            }
            
            // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾è±¡ï¼‰
            if (shouldShow && element) {
                const logLevel = element.getAttribute('data-log-level') || 'other';
                let levelShow = false;
                
                switch(logLevel) {
                    case 'info':
                        levelShow = document.getElementById('filterLevelInfo').checked;
                        break;
                    case 'warning':
                    case 'warn':
                        levelShow = document.getElementById('filterLevelWarning').checked;
                        break;
                    case 'error':
                        levelShow = document.getElementById('filterLevelError').checked;
                        break;
                    default:
                        levelShow = document.getElementById('filterLevelOther').checked;
                        break;
                }
                
                if (debugMode) {
                    console.log('Log level filter check:', {
                        logLevel,
                        levelShow,
                        finalResult: shouldShow && levelShow
                    });
                }
                
                shouldShow = shouldShow && levelShow;
            }
            
            if (debugMode) {
                console.log('Final result:', shouldShow);
            }
            
            return shouldShow;
        }

        function matchesKeywordFilter(messageElement) {
            const keywordInput = document.getElementById('keywordFilter');
            const keyword = keywordInput.value.trim().toLowerCase();
            
            if (!keyword) {
                return true; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆã¯å…¨ã¦è¡¨ç¤º
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
            const messageType = messageElement.getAttribute('data-message-type');
            
            // VRChatãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€logData.messageã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (messageType === 'log_message') {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ ¼ç´ã™ã‚‹éš ã—ãƒ‡ãƒ¼ã‚¿å±æ€§ã‚’è¿½åŠ äºˆå®š
                const messageContent = messageElement.getAttribute('data-message-content');
                if (messageContent) {
                    return messageContent.toLowerCase().includes(keyword);
                }
            }
            
            // ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã§æ¤œç´¢
            const textContent = messageElement.textContent.toLowerCase();
            return textContent.includes(keyword);
        }

        function applyFilters() {
            const messages = logArea.querySelectorAll('.message');
            if (debugMode) {
                console.log('Applying filters to', messages.length, 'messages');
            }
            
            messages.forEach(message => {
                const messageType = message.getAttribute('data-message-type') || 'system';
                const typeMatches = shouldShowMessage(messageType, message);
                const keywordMatches = matchesKeywordFilter(message);
                
                if (debugMode) {
                    console.log('Message filter check:', {
                        messageType,
                        typeMatches,
                        keywordMatches,
                        parsedType: message.getAttribute('data-parsed-type')
                    });
                }
                
                if (typeMatches && keywordMatches) {
                    message.style.display = 'block';
                } else {
                    message.style.display = 'none';
                }
            });
        }

        function toggleFilter() {
            applyFilters();
        }

        function toggleFilterButton(button) {
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            button.classList.toggle('active');
            
            // å¯¾å¿œã™ã‚‹checkboxã‚’æ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            const filterId = button.getAttribute('data-filter');
            const checkbox = document.getElementById(filterId);
            if (checkbox) {
                checkbox.checked = button.classList.contains('active');
            }
            
            // VRChatãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å ´åˆã€è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            if (filterId === 'filterLog') {
                updateVRChatFilterSections();
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
            applyFilters();
        }

        function syncButtonFromCheckbox(filterId) {
            // checkboxã®çŠ¶æ…‹ã«åˆã‚ã›ã¦ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            const checkbox = document.getElementById(filterId);
            const button = document.querySelector(`[data-filter="${filterId}"]`);
            
            if (checkbox && button) {
                if (checkbox.checked) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
            
            // VRChatãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å ´åˆã€è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            if (filterId === 'filterLog') {
                updateVRChatFilterSections();
            }
            
            applyFilters();
        }

        function updateVRChatFilterSections() {
            const vrchatLogButton = document.querySelector('[data-filter="filterLog"]');
            const vrchatLogTypeSection = document.getElementById('vrchatLogTypeSection');
            const logLevelSection = document.getElementById('logLevelSection');
            
            const isVRChatLogEnabled = vrchatLogButton && vrchatLogButton.classList.contains('active');
            
            if (isVRChatLogEnabled) {
                vrchatLogTypeSection.classList.remove('filter-section-disabled');
                logLevelSection.classList.remove('filter-section-disabled');
            } else {
                vrchatLogTypeSection.classList.add('filter-section-disabled');
                logLevelSection.classList.add('filter-section-disabled');
            }
        }

        function applyKeywordFilter() {
            applyFilters();
        }

        function clearKeywordFilter() {
            document.getElementById('keywordFilter').value = '';
            applyFilters();
        }

        function addLog(type, content, level = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = 'message';
            logEntry.setAttribute('data-message-type', 'system');
            logEntry.setAttribute('data-log-level', level);
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯
            const shouldShow = shouldShowMessage('system', logEntry) && matchesKeywordFilter(logEntry);
            if (!shouldShow) {
                logEntry.style.display = 'none';
            }
            
            // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦è‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
            let color = '#17a2b8';
            let icon = 'ğŸ”§';
            
            if (level === 'error') {
                color = '#dc3545';
                icon = 'âŒ';
            } else if (level === 'success') {
                color = '#28a745';
                icon = 'âœ…';
            } else if (level === 'info') {
                color = '#17a2b8';
                icon = 'ğŸ”§';
            }
            
            logEntry.style.borderLeftColor = color;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'message-type';
            typeSpan.innerHTML = `${icon} ${type}`;
            typeSpan.style.color = color;
            
            headerDiv.appendChild(timestamp);
            headerDiv.appendChild(typeSpan);
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'log-details';
            
            const contentField = document.createElement('div');
            contentField.className = 'log-field';
            contentField.textContent = content;
            detailsDiv.appendChild(contentField);
            
            contentDiv.appendChild(detailsDiv);
            
            logEntry.appendChild(headerDiv);
            logEntry.appendChild(contentDiv);
            
            logArea.appendChild(logEntry);
            
            performAutoScroll();
        }

        function clearLogs() {
            logArea.innerHTML = '';
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        function toggleDebug() {
            debugMode = debugToggle.checked;
            
            // æ—¢å­˜ã®ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºãƒ»éè¡¨ç¤º
            const debugInfoElements = logArea.querySelectorAll('.debug-info');
            debugInfoElements.forEach(element => {
                element.style.display = debugMode ? 'block' : 'none';
            });
            
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', `ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${debugMode ? 'ON' : 'OFF'}`, 'info');
            debugLog('Debug mode toggled:', debugMode);
        }

        function debugFilterElements() {
            const filterIds = [
                'filterLog', 'filterStatus', 'filterSystem', 'filterTest',
                'filterUserJoin', 'filterUserLeave', 'filterWorldChange', 
                'filterUdonEvent', 'filterUnknown',
                'filterLevelInfo', 'filterLevelWarning', 'filterLevelError', 'filterLevelOther'
            ];
            
            console.log('=== ãƒ•ã‚£ãƒ«ã‚¿è¦ç´ ãƒ‡ãƒãƒƒã‚° ===');
            filterIds.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}:`, element ? `å­˜åœ¨ (checked: ${element.checked})` : 'è¦‹ã¤ã‹ã‚‰ãªã„');
            });
            console.log('========================');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'VRChat Log Relay Clientã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰æ¥ç¶šã—ã¦ãã ã•ã„', 'info');
            
            // ãƒ‡ãƒãƒƒã‚°ãƒˆã‚°ãƒ«ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
            if (debugToggle) {
                debugToggle.checked = debugMode;
                toggleDebug(); // åˆæœŸçŠ¶æ…‹ã‚’é©ç”¨
            }
            
            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒˆã‚°ãƒ«ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
            const autoScrollToggle = document.getElementById('autoScrollToggle');
            if (autoScrollToggle) {
                autoScrollToggle.checked = autoScrollEnabled;
            }
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ãƒ•ã‚£ãƒ«ã‚¿è¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯
            if (debugMode) {
                debugFilterElements();
            }
        };

        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ã«WebSocketæ¥ç¶šã‚’é–‰ã˜ã‚‹
        window.onbeforeunload = function() {
            if (ws) {
                ws.close();
            }
        };

    </script>
</body>
</html>
