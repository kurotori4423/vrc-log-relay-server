<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRChat Log Relay Test Client</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px; 
            font-weight: bold;
            text-align: center;
        }
        .connected { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .disconnected { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .log-area { 
            border: 1px solid #ccc; 
            height: 1200px; 
            overflow-y: auto; 
            padding: 10px; 
            margin: 15px 0; 
            background-color: #f8f9fa; 
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        .message { 
            margin: 8px 0; 
            padding: 12px; 
            border-left: 4px solid #007bff; 
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            position: relative;
        }
        .message:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .timestamp { 
            color: #6c757d; 
            font-size: 0.85em;
            font-weight: 500;
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }
        .message-type {
            margin-left: 10px;
            font-weight: bold;
        }
        .message-content {
            margin-top: 8px;
        }
        .log-details {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 8px 0;
        }
        .log-field {
            margin: 4px 0;
            padding: 3px 0;
        }
        .log-field strong {
            color: #495057;
            min-width: 80px;
            display: inline-block;
        }
        .log-code {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 6px 8px;
            margin: 4px 0;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 12px;
            color: #495057;
            word-break: break-all;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid #e9ecef;
        }
        pre {
            background-color: #f8f9fa !important;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .info-section {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #dc3545;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        .toggle-label {
            display: flex;
            align-items: center;
            margin: 5px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ VRChat Log Relay Test Client</h1>
        
        <div id="status" class="status disconnected">æœªæ¥ç¶š</div>
        
        <div>
            <button id="connectBtn" onclick="connect()">ğŸ”— æ¥ç¶š</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>ğŸ”Œ åˆ‡æ–­</button>
            <button onclick="clearLogs()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <button onclick="sendTestMessage()">ğŸ“¨ ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</button>
            <label class="toggle-label">
                ğŸ› ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                <div class="toggle-switch">
                    <input type="checkbox" id="debugToggle" onchange="toggleDebug()">
                    <span class="toggle-slider"></span>
                </div>
            </label>
        </div>
        
        <div class="info-section" style="margin: 15px 0;">
            <h4>ğŸ” ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="filterLog" checked onchange="toggleFilter()"> 
                    ğŸ“‹ VRChatãƒ­ã‚°
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="filterStatus" checked onchange="toggleFilter()"> 
                    ğŸ® ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="filterSystem" checked onchange="toggleFilter()"> 
                    ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ 
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="filterTest" checked onchange="toggleFilter()"> 
                    ğŸ§ª ãƒ†ã‚¹ãƒˆ
                </label>
            </div>
        </div>
        
        <div id="logArea" class="log-area">
            <div class="message">
                <span class="timestamp">ã‚·ã‚¹ãƒ†ãƒ </span> - ãƒ­ã‚°ã‚¨ãƒªã‚¢ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ
            </div>
        </div>
        
        <div class="info-section">
            <h3>ğŸ“Š æ¥ç¶šæƒ…å ±</h3>
            <p><strong>WebSocketã‚µãƒ¼ãƒãƒ¼:</strong> <span id="wsUrl">ws://localhost:8080</span></p>
            <p><strong>HTTPã‚µãƒ¼ãƒãƒ¼:</strong> <span id="httpUrl">http://localhost:3001</span></p>
            <p><strong>ç¾åœ¨æ™‚åˆ»:</strong> <span id="currentTime"></span></p>
            <p><strong>æ¥ç¶šçŠ¶æ…‹:</strong> <span id="connectionState">æœªæ¥ç¶š</span></p>
        </div>
        
        <div class="info-section">
            <h3>ğŸ“ ä½¿ç”¨æ–¹æ³•</h3>
            <ol>
                <li>ã€ŒğŸ”— æ¥ç¶šã€ãƒœã‚¿ãƒ³ã§WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š</li>
                <li>VRChatãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã‚‹ã¨è‡ªå‹•ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                <li>ã€ŒğŸ“¨ ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã€ã§ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚’ãƒ†ã‚¹ãƒˆ</li>
            </ol>
        </div>
    </div>

    <script>
        let ws = null;
        const statusDiv = document.getElementById('status');
        const logArea = document.getElementById('logArea');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionState = document.getElementById('connectionState');
        const debugToggle = document.getElementById('debugToggle');

        let debugMode = false; // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°é–¢æ•°
        function debugLog(...args) {
            if (debugMode) {
                console.log(...args);
            }
        }

        // å‹•çš„ã«WebSocket URLã‚’ç”Ÿæˆ
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}`;
        const httpUrl = `${window.location.protocol}//${window.location.host}`;
        
        // URLæƒ…å ±ã‚’è¡¨ç¤º
        document.getElementById('wsUrl').textContent = wsUrl;
        document.getElementById('httpUrl').textContent = httpUrl;

        // ç¾åœ¨æ™‚åˆ»ã‚’è¡¨ç¤º
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('ja-JP');
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                debugLog('Already connected');
                addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'æ—¢ã«æ¥ç¶šæ¸ˆã¿ã§ã™', 'info');
                return;
            }

            addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...', 'info');
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                debugLog('WebSocket connected');
                statusDiv.textContent = 'âœ… æ¥ç¶šä¸­';
                statusDiv.className = 'status connected';
                connectionState.textContent = 'æ¥ç¶šä¸­';
                connectionState.className = 'success';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ', 'success');
            };

            ws.onmessage = function(event) {
                debugLog('Message received:', event.data);
                try {
                    const message = JSON.parse(event.data);
                    debugLog('Parsed message:', message); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                    addFormattedLogMessage(message);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                    addLog('RAW', event.data, 'raw');
                }
            };

            ws.onclose = function(event) {
                debugLog('WebSocket closed', event);
                statusDiv.textContent = 'âŒ åˆ‡æ–­';
                statusDiv.className = 'status disconnected';
                connectionState.textContent = 'åˆ‡æ–­';
                connectionState.className = 'error';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                addLog('ã‚·ã‚¹ãƒ†ãƒ ', `WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ (ã‚³ãƒ¼ãƒ‰: ${event.code})`, 'error');
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLog('ã‚¨ãƒ©ãƒ¼', 'WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'WebSocketæ¥ç¶šã‚’åˆ‡æ–­ã—ã¾ã—ãŸ', 'info');
            }
        }

        function sendTestMessage() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const testMessage = {
                    type: 'test',
                    message: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                    timestamp: new Date().toISOString()
                };
                ws.send(JSON.stringify(testMessage));
                addLog('é€ä¿¡', 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'info');
            } else {
                addLog('ã‚¨ãƒ©ãƒ¼', 'WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }
        }

        function addFormattedLogMessage(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'message';
            
            const messageType = message.type || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯
            if (!shouldShowMessage(messageType)) {
                return;
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
            let color = '#007bff';
            let icon = 'ğŸ“';
            let typeLabel = messageType;
            
            switch(messageType) {
                case 'vrchat_status_change':
                    color = '#28a745';
                    icon = 'ğŸ®';
                    typeLabel = 'VRChatã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´';
                    break;
                case 'log_message':
                    color = '#17a2b8';
                    icon = 'ğŸ“‹';
                    typeLabel = 'VRChatãƒ­ã‚°';
                    break;
                case 'error':
                    color = '#dc3545';
                    icon = 'âŒ';
                    typeLabel = 'ã‚¨ãƒ©ãƒ¼';
                    break;
                case 'test':
                    color = '#6f42c1';
                    icon = 'ğŸ§ª';
                    typeLabel = 'ãƒ†ã‚¹ãƒˆ';
                    break;
            }
            
            logEntry.style.borderLeftColor = color;
            logEntry.setAttribute('data-message-type', messageType);
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã‚¿ã‚¤ãƒ—ï¼‰
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            
            // VRChatãƒ­ã‚°ã®å ´åˆã¯logDataã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨
            if (messageType === 'log_message' && message.data) {
                const logData = message.data;
                if (logData.raw && logData.raw.timestamp) {
                    timestamp.textContent = new Date(logData.raw.timestamp).toLocaleTimeString('ja-JP');
                } else if (logData.timestamp) {
                    timestamp.textContent = new Date(logData.timestamp).toLocaleTimeString('ja-JP');
                } else {
                    timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
                }
            } else {
                timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
            }
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'message-type';
            typeSpan.innerHTML = `${icon} ${typeLabel}`;
            typeSpan.style.color = color;
            
            headerDiv.appendChild(timestamp);
            headerDiv.appendChild(typeSpan);
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹éƒ¨åˆ†
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (messageType === 'log_message' && message.data) {
                // VRChatãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
                const logData = message.data;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                // ãƒ¬ãƒ™ãƒ«ã¨ã‚½ãƒ¼ã‚¹ã‚’æ¨ªä¸¦ã³ã§è¡¨ç¤º
                if ((logData.raw && logData.raw.level) || logData.source) {
                    const levelSourceDiv = document.createElement('div');
                    levelSourceDiv.className = 'log-field';
                    levelSourceDiv.style.display = 'flex';
                    levelSourceDiv.style.gap = '15px';
                    
                    if (logData.raw && logData.raw.level) {
                        const levelSpan = document.createElement('span');
                        levelSpan.innerHTML = `<strong>ğŸ“Š ãƒ¬ãƒ™ãƒ«:</strong> ${logData.raw.level}`;
                        levelSourceDiv.appendChild(levelSpan);
                    }
                    
                    if (logData.source) {
                        const sourceSpan = document.createElement('span');
                        sourceSpan.innerHTML = `<strong>ğŸ” ã‚½ãƒ¼ã‚¹:</strong> ${logData.source}`;
                        levelSourceDiv.appendChild(sourceSpan);
                    }
                    
                    detailsDiv.appendChild(levelSourceDiv);
                }
                
                // å…ƒã®ãƒ­ã‚°è¡Œï¼ˆrawãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰- ãƒ©ãƒ™ãƒ«ãªã—
                if (logData.raw && logData.raw.content) {
                    const codeDiv = document.createElement('div');
                    codeDiv.className = 'log-code';
                    codeDiv.textContent = logData.raw.content;
                    codeDiv.style.margin = '8px 0 4px 0';
                    
                    detailsDiv.appendChild(codeDiv);
                }
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ï¼ˆå‡¦ç†æ¸ˆã¿ï¼‰- å…ƒã®ãƒ­ã‚°è¡Œã¨ç•°ãªã‚‹å ´åˆã®ã¿è¡¨ç¤º
                if (logData.message && logData.message !== (logData.raw && logData.raw.content)) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'log-code';
                    messageDiv.textContent = logData.message;
                    messageDiv.style.margin = '4px 0';
                    messageDiv.style.backgroundColor = '#e8f4fd';
                    messageDiv.style.borderLeft = '3px solid #007bff';
                    messageDiv.style.paddingLeft = '10px';
                    
                    detailsDiv.appendChild(messageDiv);
                }
                
                // ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿æƒ…å ±
                if (logData.parsed && Object.keys(logData.parsed).length > 0) {
                    const parsedField = document.createElement('div');
                    parsedField.className = 'log-field';
                    parsedField.innerHTML = `<strong>âš™ï¸ è§£æçµæœ:</strong>`;
                    
                    const parsedDiv = document.createElement('div');
                    parsedDiv.className = 'log-details';
                    parsedDiv.style.marginTop = '5px';
                    parsedDiv.style.backgroundColor = '#ffffff';
                    parsedDiv.style.border = '1px solid #dee2e6';
                    
                    // ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸå„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
                    for (const [key, value] of Object.entries(logData.parsed)) {
                        const fieldDiv = document.createElement('div');
                        fieldDiv.className = 'log-field';
                        fieldDiv.innerHTML = `<strong>${key}:</strong> <code style="background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px;">${value}</code>`;
                        parsedDiv.appendChild(fieldDiv);
                    }
                    
                    parsedField.appendChild(parsedDiv);
                    detailsDiv.appendChild(parsedField);
                }
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±: å®Œå…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ï¼ˆå¸¸ã«ä½œæˆã€è¡¨ç¤ºãƒ»éè¡¨ç¤ºã¯CSSã§åˆ¶å¾¡ï¼‰
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(logData, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
                
            } else if (messageType === 'vrchat_status_change' && message.data) {
                // VRChatã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®å ´åˆ
                const statusData = message.data;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                const statusField = document.createElement('div');
                statusField.className = 'log-field';
                const prevStatus = statusData.previousStatus || 'ä¸æ˜';
                const currStatus = statusData.currentStatus || 'ä¸æ˜';
                statusField.innerHTML = `<strong>ğŸ”„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´:</strong> <span style="color: #dc3545;">${prevStatus}</span> â†’ <span style="color: #28a745;">${currStatus}</span>`;
                detailsDiv.appendChild(statusField);
                
                if (statusData.processInfo) {
                    const processField = document.createElement('div');
                    processField.className = 'log-field';
                    processField.innerHTML = `<strong>ğŸ”§ ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±:</strong> PID ${statusData.processInfo.processId}, æ¤œå‡ºæ–¹æ³•: ${statusData.processInfo.detectionMethod}`;
                    detailsDiv.appendChild(processField);
                }
                
                if (statusData.timestamp) {
                    const timeField = document.createElement('div');
                    timeField.className = 'log-field';
                    timeField.innerHTML = `<strong>ğŸ“… å¤‰æ›´æ™‚åˆ»:</strong> ${new Date(statusData.timestamp).toLocaleString('ja-JP')}`;
                    detailsDiv.appendChild(timeField);
                }
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±: å®Œå…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ï¼ˆå¸¸ã«ä½œæˆã€è¡¨ç¤ºãƒ»éè¡¨ç¤ºã¯CSSã§åˆ¶å¾¡ï¼‰
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(statusData, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
                
            } else {
                // ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'log-details';
                
                const pre = document.createElement('pre');
                pre.style.background = '#ffffff';
                pre.style.border = '1px solid #dee2e6';
                pre.style.borderRadius = '3px';
                pre.style.fontSize = '11px';
                pre.style.margin = '0';
                pre.style.padding = '8px';
                pre.style.whiteSpace = 'pre-wrap';
                pre.style.fontFamily = 'Courier New, Consolas, monospace';
                pre.textContent = JSON.stringify(message, null, 2);
                
                detailsDiv.appendChild(pre);
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±: å®Œå…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹é€ ï¼ˆå¸¸ã«ä½œæˆã€è¡¨ç¤ºãƒ»éè¡¨ç¤ºã¯CSSã§åˆ¶å¾¡ï¼‰
                const debugField = document.createElement('div');
                debugField.className = 'log-field debug-info';
                debugField.style.display = debugMode ? 'block' : 'none';
                debugField.innerHTML = `<strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>`;
                
                const debugDiv = document.createElement('div');
                debugDiv.className = 'log-details';
                debugDiv.style.marginTop = '5px';
                debugDiv.style.backgroundColor = '#f8f9fa';
                debugDiv.style.border = '1px solid #dee2e6';
                debugDiv.style.fontSize = '11px';
                
                const debugPre = document.createElement('pre');
                debugPre.style.margin = '0';
                debugPre.style.padding = '8px';
                debugPre.style.whiteSpace = 'pre-wrap';
                debugPre.style.fontFamily = 'Courier New, Consolas, monospace';
                debugPre.textContent = JSON.stringify(message, null, 2);
                
                debugDiv.appendChild(debugPre);
                debugField.appendChild(debugDiv);
                detailsDiv.appendChild(debugField);
                
                contentDiv.appendChild(detailsDiv);
            }
            
            logEntry.appendChild(headerDiv);
            logEntry.appendChild(contentDiv);
            
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function shouldShowMessage(messageType) {
            switch(messageType) {
                case 'log_message':
                    return document.getElementById('filterLog').checked;
                case 'vrchat_status_change':
                    return document.getElementById('filterStatus').checked;
                case 'test':
                    return document.getElementById('filterTest').checked;
                default:
                    return document.getElementById('filterSystem').checked;
            }
        }

        function toggleFilter() {
            const messages = logArea.querySelectorAll('.message');
            messages.forEach(message => {
                const messageType = message.getAttribute('data-message-type') || 'system';
                if (shouldShowMessage(messageType)) {
                    message.style.display = 'block';
                } else {
                    message.style.display = 'none';
                }
            });
        }

        function addLog(type, content, level = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = 'message';
            logEntry.setAttribute('data-message-type', 'system');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯
            if (!shouldShowMessage('system')) {
                return;
            }
            
            // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦è‰²ã¨ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
            let color = '#17a2b8';
            let icon = 'ğŸ”§';
            
            if (level === 'error') {
                color = '#dc3545';
                icon = 'âŒ';
            } else if (level === 'success') {
                color = '#28a745';
                icon = 'âœ…';
            } else if (level === 'info') {
                color = '#17a2b8';
                icon = 'ğŸ”§';
            }
            
            logEntry.style.borderLeftColor = color;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'message-type';
            typeSpan.innerHTML = `${icon} ${type}`;
            typeSpan.style.color = color;
            
            headerDiv.appendChild(timestamp);
            headerDiv.appendChild(typeSpan);
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'log-details';
            
            const contentField = document.createElement('div');
            contentField.className = 'log-field';
            contentField.textContent = content;
            detailsDiv.appendChild(contentField);
            
            contentDiv.appendChild(detailsDiv);
            
            logEntry.appendChild(headerDiv);
            logEntry.appendChild(contentDiv);
            
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLogs() {
            logArea.innerHTML = '';
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        function toggleDebug() {
            debugMode = debugToggle.checked;
            
            // æ—¢å­˜ã®ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºãƒ»éè¡¨ç¤º
            const debugInfoElements = logArea.querySelectorAll('.debug-info');
            debugInfoElements.forEach(element => {
                element.style.display = debugMode ? 'block' : 'none';
            });
            
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', `ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ${debugMode ? 'ON' : 'OFF'}`, 'info');
            debugLog('Debug mode toggled:', debugMode);
        }

        function sendTestMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('ã‚¨ãƒ©ãƒ¼', 'WebSocketã«æ¥ç¶šã—ã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const testMessage = {
                type: 'test',
                data: {
                    message: 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                    timestamp: new Date().toISOString(),
                    client: 'test-client'
                }
            };
            
            ws.send(JSON.stringify(testMessage));
            addLog('ãƒ†ã‚¹ãƒˆ', 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'info');
            debugLog('Test message sent:', testMessage);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'VRChat Log Relay Test Clientã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
            addLog('ã‚·ã‚¹ãƒ†ãƒ ', 'ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰æ¥ç¶šã—ã¦ãã ã•ã„', 'info');
            
            // ãƒ‡ãƒãƒƒã‚°ãƒˆã‚°ãƒ«ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
            if (debugToggle) {
                debugToggle.checked = debugMode;
                toggleDebug(); // åˆæœŸçŠ¶æ…‹ã‚’é©ç”¨
            }
        };

        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ã«WebSocketæ¥ç¶šã‚’é–‰ã˜ã‚‹
        window.onbeforeunload = function() {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>
