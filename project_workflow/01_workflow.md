# VRChat Log Relay Server - プロジェクトワークフロー

## 🎯 このファイルについて

このファイルは **VRChat Log Relay Server** プロジェクトを実装する作業者が**最初に読むべき**ガイドです。プロジェクトの知識が全くない状態でも、この指示に従うことで適切に作業を進めることができます。

## 📋 プロジェクト理解のためのファイル読取順序

作業を開始する前に、以下の順序でドキュメントを読んでください：

### 1. 現在の状態を確認
**[13_progress.md](./13_progless.md)** を確認し現在作業中なら 「4. 作業管理」と、作業中ルール、作業完了時の必須作業を読み続きから作業。

### 1. 基本理解（必須）
1. **[02_project_overview.md](./02_project_overview.md)** - プロジェクトの概要と目的
2. **[03_file_structure.md](./03_file_structure.md)** - ファイル構成とディレクトリ構造
3. **[04_tech_stack.md](./04_tech_stack.md)** - 技術スタックと開発環境

### 2. 実装仕様（実装時に参照）
4. **[05_core_features.md](./05_core_features.md)** - 主要機能の設計仕様
5. **[06_api_specifications.md](./06_api_specifications.md)** - WebSocketプロトコル仕様
6. **[07_class_design.md](./07_class_design.md)** - クラス設計とアーキテクチャ
7. **[08_algorithms.md](./08_algorithms.md)** - 主要アルゴリズムの実装方法

### 3. 設定・運用（実装後に参照）
8. **[09_configuration.md](./09_configuration.md)** - 設定ファイルと環境設定
9. **[10_deployment.md](./10_deployment.md)** - デプロイメントと運用方法
10. **[11_client_examples.md](./11_client_examples.md)** - クライアント実装例

### 4. 作業管理
11. **[12_task_todo.md](./12_task_todo.md)** - タスク管理とTODOリスト（常に最新状態を維持）

## � タスク管理原則（★必読★）

### 作業単位の基準
- **1タスク = 1時間以内**: すべてのタスクは1時間程度で完了する単位に分割（サブタスクはひとまとめになります。）
- **即座テスト可能**: 実装した機能は必ずテスト可能な状態にする
- **ドキュメント先行**: 重大な仕様変更が必要な場合はユーザーに相談

### 作業完了時の必須作業
各タスク完了時に以下を必ず実行：
1. **作業内容の記録**: 何を実装したか、どのファイルを変更したかをproject_workflow/archive/以下に{タスク名}_archive.mdとして記録
2. **テスト実行**: 実装した機能のテストを実行し、結果を{タスク名}_archive.mdに記録
3. **テストファイル管理**: 作成したテストスクリプトは `tests/` フォルダに格納する（一時的なテストファイルは削除）
4. **課題の抽出**: 次の作業での課題や懸念事項を特定
5. **新タスクの追加**: 作業中に発見した新しいタスクをTODOリストに追加
6. **進捗更新**: `12_task_todo.md` の該当タスクを完了マークに更新
7. **13_progless.mdの初期化** :  `13_progless.md`の初期化を行います。
7. **報告**: タスクが完了したことをユーザーに報告し待機


### 作業中ルール
下記の作業をしたら、そこまでの作業を[13_progless.md](./13_progless.md)に記録します。

- １つのファイルを編集し終えた。
- 不具合を解決した。もしくは不具合の修正に５回失敗した
- 実装が完了してテストの作成に入る
- テストが完了した
- 作業内容をアーカイブ記録した

完了したら、01_workflow.mdを**必ず**再読します。

## �🚀 実装開始手順

### ステップ1: 環境準備
```bash
# 1. Node.js 22.x のインストール確認
node --version

# 2. プロジェクトルートでpackage.json作成
npm init -y

# 3. 必要な依存関係のインストール
npm install express ws chokidar tail winston dotenv js-yaml
npm install -D typescript @types/node @types/express @types/ws jest @types/jest ts-jest eslint prettier

# 4. TypeScript設定
npx tsc --init
```

### ステップ2: 基本ファイル構造作成
1. `03_file_structure.md` を参照してディレクトリ構造を作成
2. `src/` フォルダ以下の基本ファイルを作成
3. 設定ファイル（`config/`）の作成

### ステップ3: 実装順序
**以下の順序で実装することを強く推奨（各項目は1時間程度のタスクに分割）：**

#### Phase 1: 基盤実装 (4-5時間)
1. **基盤クラス** - 1時間
   - `types/index.ts`: 基本型定義
   - `utils/logger.ts`: ロガー実装
   - **テスト**: ロガーの出力確認

2. **設定管理** - 1時間
   - `server/config.ts`: 設定読み込み機能
   - **テスト**: 設定ファイル読み込み確認

3. **ログファイル監視基盤** - 1時間
   - `log/VRChatLogWatcher.ts`: ファイル監視の基本構造
   - **テスト**: ダミーファイルでの監視動作確認

4. **メッセージ解析基盤** - 1時間
   - `log/MessageProcessor.ts`: ログ解析の基本構造
   - **テスト**: サンプルログでの解析動作確認

#### Phase 2: コア機能実装 (4-5時間)
5. **WebSocketサーバー基盤** - 1時間
   - `websocket/WebSocketServer.ts`: 接続管理の基本構造
   - **テスト**: WebSocketクライアントでの接続確認

6. **メインサーバー統合** - 1時間
   - `server/LogRelayServer.ts`: 各コンポーネントの統合
   - **テスト**: 統合動作の基本確認

7. **エントリーポイント** - 1時間
   - `index.ts`: アプリケーション起動処理
   - **テスト**: サーバー起動・停止確認

#### Phase 3: 高度機能・UI (6-8時間)
8. **VRChatプロセス監視** - 2時間
   - プロセス検知ロジック実装
   - **テスト**: VRChat起動・終了での検知確認

9. **管理UI基盤** - 2時間
   - web-ui/ の基本構造
   - **テスト**: ブラウザでの表示確認

10. **管理UI機能** - 2時間
    - クライアント一覧、ログ表示機能
    - **テスト**: UI操作での動作確認

#### Phase 4: テスト・最適化 (4-6時間)
11. **単体テスト実装** - 2時間
    - 各コンポーネントのテスト
    - **テスト**: テストスイート実行

12. **統合テスト・最適化** - 2時間
    - エンドツーエンドテスト
    - パフォーマンス調整

## 📝 タスク管理原則

### 作業単位の基準
- **1タスク = 1時間以内**: すべてのタスクは1時間程度で完了する単位に分割
- **即座テスト可能**: 実装した機能は必ずテスト可能な状態にする
- **ドキュメント先行**: 重大な仕様変更が必要な場合はユーザーに相談

### 作業完了時の必須作業
各タスク完了時に以下を必ず実行：
1. **作業内容の記録**: 何を実装したか、どのファイルを変更したかを記録
2. **テスト実行**: 実装した機能のテストを実行し、結果を記録
3. **課題の抽出**: 次の作業での課題や懸念事項を特定
4. **新タスクの追加**: 作業中に発見した新しいタスクをTODOリストに追加
5. **進捗更新**: `12_task_todo.md` の該当タスクを完了マークに更新

### 定期確認ルール
**作業中は定期的に以下を復唱する**：
> "私は project_workflow/01_workflow.md に従いタスクを進めています。何をしているかわからなくなったらここをチェックします。"

## ⚠️ 重要な実装ポイント

### セキュリティ方針
- **ローカル環境専用**: `127.0.0.1` のみバインド
- **認証機能なし**: シンプルな実装を維持
- **最小権限**: ファイル読み取りのみ、書き込み不要

### パフォーマンス要件
- ログ検出→配信: **100ms以内**
- 同時接続: **50クライアント**
- メモリ使用量: **128MB以内**

### 主要技術要素
- **VRChatプロセス監視**: Windows環境でのプロセス検知
- **ファイル監視**: chokidar を使用したリアルタイム監視
- **Tail機能**: tail ライブラリでログファイル追従
- **WebSocket配信**: ws ライブラリによる複数クライアント対応

## 🔄 継続的な作業管理

### タスク完了時の必須チェックリスト
各タスク完了時に以下を必ず実行：
- [ ] 実装内容をコードコメントで記録
- [ ] 該当機能のテストを実行し、結果を記録
- [ ] 次の作業での課題・懸念事項を `12_task_todo.md` に記録
- [ ] 作業中に発見した新しいタスクを TODO リストに追加
- [ ] 完了したタスクに完了マークと日時を記録

### 仕様変更が必要な場合の対応
以下の状況では作業を停止し、ユーザーに相談：
- **API仕様の大幅変更が必要**
- **パフォーマンス要件を満たせない**
- **セキュリティ上の重大な問題を発見**
- **技術スタックの変更が必要**

### タスク管理ルール
1. 作業開始前に `12_task_todo.md` を確認
2. **1時間経過時点**で進捗を評価、必要に応じてタスクを分割
3. 完了したタスクは日付とともに完了マークを付ける
4. 問題や懸念事項があれば課題セクションに記録
5. **定期的な復唱**: "私は project_workflow/01_workflow.md に従いタスクを進めています。"

### コード品質基準
- **TypeScript**: strict モードで型安全性を確保
- **ESLint**: コード品質チェック
- **Prettier**: コードフォーマット統一
- **Jest**: 単体テスト実装（テストカバレッジ80%以上）
- **コメント**: 複雑なロジックには必ず日本語コメント
- **テスト駆動**: 各機能実装後、即座にテスト実行

### ドキュメント更新ルール
- 設計変更があった場合は該当ドキュメントを即座に更新
- 新機能追加時は仕様書も同時更新
- API変更は `06_api_specifications.md` を必ず更新

## 🧪 テスト管理ルール（★重要★）

### テストファイル格納規則
- **格納場所**: すべてのテストファイルは `tests/` フォルダに格納
- **ファイル命名**: `{タスク名}.test.ts` （例: `P1-T2-基盤クラス.test.ts`）
- **一時テストファイル**: プロジェクトルートに作成した一時的なテストファイルは作業完了後に削除
- **Jest設定**: `jest.config.js` を使用してテスト実行

### テストファイル構造
```
tests/
├── unit/                    # 単体テスト
│   ├── P1-T2-基盤クラス.test.ts
│   ├── P1-T3-設定管理.test.ts
│   └── ...
├── integration/             # 統合テスト
│   ├── log-watcher.test.ts
│   └── websocket.test.ts
└── fixtures/                # テストデータ
    ├── sample-logs/
    └── mock-configs/
```

### テスト実行ルール
- **各タスク完了時**: 実装した機能のテストを必ず実行
- **テスト結果記録**: archive/{タスク名}_archive.md に結果を記録
- **テストコマンド**: `npm test` でJest実行
- **継続的テスト**: `npm run test:watch` で開発中の継続的テスト

### テストタイプ別指針
1. **単体テスト**: 各クラス・関数の個別テスト
2. **統合テスト**: コンポーネント間の連携テスト
3. **機能テスト**: 実際のVRChatログファイルでの動作テスト
4. **パフォーマンステスト**: メモリ使用量・処理速度の検証

### テストデータ管理
- **フィクスチャ**: `tests/fixtures/` にサンプルデータを格納
- **モック**: 外部依存（VRChatプロセス、ファイルシステム）のモック作成
- **環境分離**: テスト実行時は本番ログファイルに影響を与えない

## 🆘 困った時の対処法

### よくある問題
1. **VRChatプロセスが検出できない**
   - `08_algorithms.md` のプロセス監視アルゴリズムを参照
   - Windows での `wmic` コマンド権限を確認

2. **ログファイルが見つからない**
   - VRChatのログディレクトリパスが正しいか確認
   - `%LOCALAPPDATA%\Low\VRChat\VRChat\` の存在を確認

3. **WebSocket接続エラー**
   - ポート競合の確認 (8080)
   - ファイアウォール設定の確認

### 相談・質問方法
- 技術的な質問: 該当する仕様書のセクションを参照
- 設計変更が必要: プロジェクト概要と照らし合わせて判断
- 実装詳細: クラス設計書とアルゴリズム書を参照

## 📊 進捗確認方法

### マイルストーン（タスクベース）
- [ ] **Phase 1**: 基盤実装 (4-5個のタスク、4-5時間)
- [ ] **Phase 2**: コア機能実装 (3個のタスク、3時間)  
- [ ] **Phase 3**: 高度機能・UI (6個のタスク、6-8時間)
- [ ] **Phase 4**: テスト・最適化 (4個のタスク、4-6時間)

### 各タスク完了時の動作確認手順
**基盤実装時**:
1. 実装したモジュールの単体テスト実行
2. 依存関係のある他モジュールとの結合確認
3. エラーハンドリングの動作確認

**機能実装時**:
1. VRChatを起動していない状態でサーバー起動
2. サーバーログでプロセス監視が動作していることを確認
3. VRChatを起動してプロセス検知を確認
4. テストクライアントでWebSocket接続を確認
5. VRChatでワールド移動しログ配信を確認

### タスク時間管理
- **開始時**: タスク開始時刻を記録
- **中間確認**: 30分経過時点で進捗評価
- **1時間経過**: タスクを分割するか継続するかを判断
- **完了時**: 実際の所要時間を記録し、次回の見積もりに活用

---

**🎯 作業開始準備完了チェックリスト**
- [ ] 全ドキュメント (02-11) を読み終えた
- [ ] 開発環境 (Node.js, npm) が準備できた
- [ ] プロジェクト構造を理解した
- [ ] 実装順序とタスク分割を把握した
- [ ] タスクTODOファイルを確認した
- [ ] 1時間単位のタスク管理ルールを理解した
- [ ] テスト駆動開発の必要性を理解した

**📝 作業中の定期確認**
定期的に復唱：
> "私は project_workflow/01_workflow.md に従いタスクを進めています。何をしているかわからなくなったらここをチェックします。"

準備ができたら `12_task_todo.md` の最初のタスクから開始してください！
